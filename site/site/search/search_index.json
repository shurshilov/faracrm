{"config":{"lang":["ru","en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"FARA CRM","text":"<p>\u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u044f \u0434\u043b\u044f \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432.</p> <p>FARA CRM \u2014 \u043c\u043e\u0434\u0443\u043b\u044c\u043d\u0430\u044f CRM-\u0441\u0438\u0441\u0442\u0435\u043c\u0430 \u043d\u0430 FastAPI + React \u0441 \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u043c ORM (DotORM), real-time \u0447\u0430\u0442\u043e\u043c \u0447\u0435\u0440\u0435\u0437 WebSocket \u0438 \u0438\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0435\u0439 \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c\u0438 \u043c\u0435\u0441\u0441\u0435\u043d\u0434\u0436\u0435\u0440\u0430\u043c\u0438.</p>"},{"location":"#_1","title":"\u0421\u0442\u0435\u043a","text":"\u0421\u043b\u043e\u0439 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u0438 Backend Python 3.12+, FastAPI, asyncpg, PostgreSQL ORM DotORM (\u0441\u043e\u0431\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439 async ORM) Frontend React 18, TypeScript, Mantine UI v8, Redux Toolkit Real-time WebSocket + PostgreSQL LISTEN/NOTIFY (Redis \u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e) \u0418\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0438 Telegram, WhatsApp, Avito, Email (IMAP/SMTP)"},{"location":"#_2","title":"\u0411\u044b\u0441\u0442\u0440\u044b\u0439 \u0441\u0442\u0430\u0440\u0442","text":"BackendFrontend <pre><code>cd backend\npip install -r requirements.txt\ncp .env.example .env          # \u043d\u0430\u0441\u0442\u0440\u043e\u0438\u0442\u044c DB_URL\npython main.py\n</code></pre> <pre><code>cd frontend\nyarn install\nyarn dev\n# http://localhost:5173\n</code></pre>"},{"location":"#_3","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u043f\u0440\u043e\u0435\u043a\u0442\u0430","text":"<pre><code>fara/\n\u251c\u2500\u2500 backend/\n\u2502   \u251c\u2500\u2500 main.py                  # FastAPI entry point\n\u2502   \u251c\u2500\u2500 cron_main.py             # Cron-\u0437\u0430\u0434\u0430\u0447\u0438\n\u2502   \u251c\u2500\u2500 project_setup.py         # Models, Apps, Settings\n\u2502   \u2514\u2500\u2500 base/\n\u2502       \u251c\u2500\u2500 system/              # \u042f\u0434\u0440\u043e: ORM, auth, services\n\u2502       \u2502   \u251c\u2500\u2500 dotorm/          # DotORM \u2014 async ORM\n\u2502       \u2502   \u251c\u2500\u2500 dotorm_crud_auto/# \u0410\u0432\u0442\u043e-\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f CRUD API\n\u2502       \u2502   \u251c\u2500\u2500 core/            # Environment, Service\n\u2502       \u2502   \u251c\u2500\u2500 logger/\n\u2502       \u2502   \u2514\u2500\u2500 schemas/\n\u2502       \u2514\u2500\u2500 crm/                 # \u0411\u0438\u0437\u043d\u0435\u0441-\u043c\u043e\u0434\u0443\u043b\u0438\n\u2502           \u251c\u2500\u2500 chat/            # \u0427\u0430\u0442 + WebSocket\n\u2502           \u251c\u2500\u2500 security/        # ACL, \u0441\u0435\u0441\u0441\u0438\u0438, \u0440\u043e\u043b\u0438\n\u2502           \u251c\u2500\u2500 users/\n\u2502           \u251c\u2500\u2500 leads/\n\u2502           \u251c\u2500\u2500 sales/\n\u2502           \u251c\u2500\u2500 partners/\n\u2502           \u251c\u2500\u2500 company/\n\u2502           \u251c\u2500\u2500 products/\n\u2502           \u251c\u2500\u2500 tasks/\n\u2502           \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 frontend/\n\u2502   \u2514\u2500\u2500 src/\n\u2502       \u251c\u2500\u2500 services/api/        # RTK Query API\n\u2502       \u251c\u2500\u2500 store/               # Redux store\n\u2502       \u251c\u2500\u2500 fara_chat/           # \u041c\u043e\u0434\u0443\u043b\u044c \u0447\u0430\u0442\u0430\n\u2502       \u251c\u2500\u2500 fara_leads/\n\u2502       \u251c\u2500\u2500 fara_sales/\n\u2502       \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 tests/\n\u2502   \u251c\u2500\u2500 conftest.py\n\u2502   \u251c\u2500\u2500 integration/\n\u2502   \u2514\u2500\u2500 performance/\n\u2514\u2500\u2500 docs/                        # \u2190 \u044d\u0442\u0430 \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u044f\n</code></pre>"},{"location":"#_4","title":"\u041d\u0430\u0432\u0438\u0433\u0430\u0446\u0438\u044f","text":"<ul> <li> <p> Backend</p> <p>\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430, DotORM, \u043c\u043e\u0434\u0443\u043b\u0438, API</p> <p> Backend</p> </li> <li> <p> Frontend</p> <p>React-\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435, state management, \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b</p> <p> Frontend</p> </li> <li> <p> \u0413\u0430\u0439\u0434\u044b</p> <p>\u041f\u043e\u0448\u0430\u0433\u043e\u0432\u044b\u0435 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438: \u043d\u043e\u0432\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c, WebSocket, \u0442\u0435\u0441\u0442\u044b</p> <p> \u0413\u0430\u0439\u0434\u044b</p> </li> </ul>"},{"location":"backend/","title":"Backend","text":"<p>FastAPI-\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0441 \u043c\u043e\u0434\u0443\u043b\u044c\u043d\u043e\u0439 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043e\u0439, \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u043c ORM \u0438 \u0430\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0435\u0439 CRUD API.</p>"},{"location":"backend/#_1","title":"\u041a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u043a\u043e\u043d\u0446\u0435\u043f\u0446\u0438\u0438","text":"<p>Environment \u2014 \u0446\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f. \u0421\u043e\u0434\u0435\u0440\u0436\u0438\u0442 <code>models</code>, <code>apps</code>, <code>settings</code> \u0438 \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0436\u0438\u0437\u043d\u0435\u043d\u043d\u044b\u043c \u0446\u0438\u043a\u043b\u043e\u043c \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432.</p> <p>Service \u2014 \u0431\u0430\u0437\u043e\u0432\u044b\u0439 \u043a\u043b\u0430\u0441\u0441 \u043c\u043e\u0434\u0443\u043b\u0435\u0439. \u041a\u0430\u0436\u0434\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c (chat, security, users...) \u2014 \u044d\u0442\u043e <code>Service</code> \u0441 \u043c\u0435\u0442\u043e\u0434\u0430\u043c\u0438 <code>startup()</code>, <code>shutdown()</code>, <code>post_init()</code>.</p> <p>DotORM \u2014 \u0430\u0441\u0438\u043d\u0445\u0440\u043e\u043d\u043d\u044b\u0439 ORM \u0441 \u0434\u0435\u043a\u043b\u0430\u0440\u0430\u0442\u0438\u0432\u043d\u044b\u043c\u0438 \u043c\u043e\u0434\u0435\u043b\u044f\u043c\u0438, \u0430\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0435\u0439 DDL \u0438 CRUD API.</p>"},{"location":"backend/#entry-points","title":"Entry Points","text":"backend/main.py<pre><code>from contextlib import asynccontextmanager\nfrom fastapi import FastAPI\n\n@asynccontextmanager\nasync def lifespan(application: FastAPI):\n    \"\"\"Application lifecycle \u2014 \u0437\u0430\u043f\u0443\u0441\u043a \u0438 \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432.\"\"\"\n    env = Environment(Settings, Models, Apps)\n    application.state.env = env\n\n    await env.setup_services()\n    await env.start_services_before(application)\n    await env.load_routers(application)\n    await env.start_services_after(application)\n    await env.start_post_init(application)\n\n    yield\n\n    await env.stop_services(application)\n\napp = FastAPI(lifespan=lifespan)\n</code></pre>"},{"location":"backend/#_2","title":"\u0420\u0430\u0437\u0434\u0435\u043b\u044b","text":"\u0420\u0430\u0437\u0434\u0435\u043b \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 Environment, Service, \u0436\u0438\u0437\u043d\u0435\u043d\u043d\u044b\u0439 \u0446\u0438\u043a\u043b DotORM \u041c\u043e\u0434\u0435\u043b\u0438, \u043f\u043e\u043b\u044f, \u0437\u0430\u043f\u0440\u043e\u0441\u044b, \u0441\u0432\u044f\u0437\u0438 \u041c\u043e\u0434\u0443\u043b\u0438 \u0427\u0430\u0442, Security \u0438 \u0434\u0440\u0443\u0433\u0438\u0435 CRM-\u043c\u043e\u0434\u0443\u043b\u0438 \u0422\u0435\u0441\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 pytest, fixtures, integration tests"},{"location":"backend/architecture/environment/","title":"Environment","text":"<p><code>Environment</code> \u2014 \u0446\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f. \u0414\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0447\u0435\u0440\u0435\u0437 <code>app.state.env</code> \u0432 \u0440\u043e\u0443\u0442\u0435\u0440\u0430\u0445 \u0438 \u0447\u0435\u0440\u0435\u0437 \u0441\u0438\u043d\u0433\u043b\u0442\u043e\u043d <code>env</code> \u0432 \u043c\u043e\u0434\u0435\u043b\u044f\u0445.</p>"},{"location":"backend/architecture/environment/#_1","title":"\u0414\u043e\u0441\u0442\u0443\u043f","text":"\u0412 \u0440\u043e\u0443\u0442\u0435\u0440\u0435 (\u0447\u0435\u0440\u0435\u0437 request)\u0412 \u043c\u043e\u0434\u0435\u043b\u0438 (\u0447\u0435\u0440\u0435\u0437 \u0441\u0438\u043d\u0433\u043b\u0442\u043e\u043d) <pre><code>@router.get(\"/items\")\nasync def get_items(req: Request):\n    env: Environment = req.app.state.env\n    items = await env.models.product.search(\n        filter=[(\"active\", \"=\", True)],\n        fields=[\"id\", \"name\", \"price\"],\n    )\n    return {\"data\": items}\n</code></pre> <pre><code>from backend.base.system.core.enviroment import env\n\nclass ChatMember(DotModel):\n    @classmethod\n    async def get_membership(cls, chat_id, user_id):\n        return await env.models.chat_member.search(\n            filter=[\n                (\"chat_id\", \"=\", chat_id),\n                (\"user_id\", \"=\", user_id),\n            ],\n            limit=1,\n        )\n</code></pre>"},{"location":"backend/architecture/environment/#_2","title":"\u0410\u0442\u0440\u0438\u0431\u0443\u0442\u044b","text":"\u0410\u0442\u0440\u0438\u0431\u0443\u0442 \u0422\u0438\u043f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>env.models</code> <code>Models</code> \u0412\u0441\u0435 \u0437\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 DotModel-\u043a\u043b\u0430\u0441\u0441\u044b <code>env.apps</code> <code>Apps</code> \u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b <code>env.settings</code> <code>Settings</code> \u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f \u0438\u0437 <code>.env</code> <code>env.services_before</code> <code>list[Service]</code> \u0421\u0435\u0440\u0432\u0438\u0441\u044b, \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0435 \u0434\u043e \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432 <code>env.services_after</code> <code>list[Service]</code> \u0421\u0435\u0440\u0432\u0438\u0441\u044b, \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0435 \u043f\u043e\u0441\u043b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432"},{"location":"backend/architecture/environment/#models","title":"Models","text":"<p><code>env.models</code> \u2014 \u044d\u0442\u043e namespace \u0441 \u043c\u043e\u0434\u0435\u043b\u044f\u043c\u0438. \u041a\u0430\u0436\u0434\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0430 \u043f\u043e \u0438\u043c\u0435\u043d\u0438, \u0437\u0430\u0434\u0430\u043d\u043d\u043e\u043c\u0443 \u0432 <code>project_setup.py</code>:</p> <pre><code># project_setup.py\nclass Models(ModelsCore):\n    user = User\n    chat = Chat\n    chat_message = ChatMessage\n\n# \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435:\nuser = await env.models.user.get(user_id)\nmessages = await env.models.chat_message.search(\n    filter=[(\"chat_id\", \"=\", 1)],\n    fields=[\"id\", \"body\", \"author_user_id\"],\n)\n</code></pre>"},{"location":"backend/architecture/environment/#settings","title":"Settings","text":"<p>\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u044e\u0442\u0441\u044f \u0438\u0437 <code>.env</code> \u0447\u0435\u0440\u0435\u0437 Pydantic Settings:</p> backend/project_setup.py<pre><code>class Settings(SettingsCore):\n    model_config = SettingsConfigDict(\n        env_nested_delimiter=\"__\",   # DB__HOST \u2192 settings.db.host\n        extra=\"ignore\",\n    )\n\n    class DatabaseSettings(BaseSettings):\n        host: str = \"localhost\"\n        port: int = 5432\n        name: str = \"fara\"\n        user: str = \"postgres\"\n        password: str = \"\"\n\n    db: DatabaseSettings = DatabaseSettings()\n</code></pre> .env<pre><code>DB__HOST=localhost\nDB__PORT=5432\nDB__NAME=fara_crm\nDB__USER=postgres\nDB__PASSWORD=secret\n</code></pre>"},{"location":"backend/architecture/overview/","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 Backend","text":""},{"location":"backend/architecture/overview/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<pre><code>graph TB\n    subgraph FastAPI[\"FastAPI Application\"]\n        MW[Middleware: Auth, CORS]\n        R[Routers]\n    end\n\n    subgraph Environment\n        S[Settings]\n        M[Models]\n        A[Apps / Services]\n    end\n\n    subgraph Services\n        DB[PostgresDB Service]\n        AUTH[AuthToken Service]\n        CHAT[Chat Service]\n        CRUD[CRUD Auto Service]\n        SEC[Security Service]\n    end\n\n    subgraph DotORM\n        MOD[DotModel]\n        BLD[Builder]\n        SES[Session / Pool]\n    end\n\n    FastAPI --&gt; Environment\n    Environment --&gt; Services\n    Services --&gt; DotORM\n    DotORM --&gt; PG[(PostgreSQL)]\n    CHAT --&gt; WS[WebSocket Manager]\n    WS --&gt; PUBSUB[PubSub: PG LISTEN/NOTIFY]\n    PUBSUB --&gt; PG</code></pre>"},{"location":"backend/architecture/overview/#_2","title":"\u0416\u0438\u0437\u043d\u0435\u043d\u043d\u044b\u0439 \u0446\u0438\u043a\u043b \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f","text":"<p>\u041f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f \u0432 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0451\u043d\u043d\u043e\u043c \u043f\u043e\u0440\u044f\u0434\u043a\u0435 \u2014 \u044d\u0442\u043e \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e \u0434\u043b\u044f \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u043e\u0439 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438:</p> <pre><code>sequenceDiagram\n    participant M as main.py\n    participant E as Environment\n    participant SB as services_before\n    participant SA as services_after\n\n    M-&gt;&gt;E: Environment(Settings, Models, Apps)\n    E-&gt;&gt;E: setup_services()\n    E-&gt;&gt;SB: start_services_before(app)\n    Note over SB: DB Pool, Logger, Security\n    E-&gt;&gt;E: load_routers(app)\n    E-&gt;&gt;SA: start_services_after(app)\n    Note over SA: CRUD Auto, Chat PubSub\n    E-&gt;&gt;E: start_post_init(app)\n    Note over E: Default data, migrations</code></pre>"},{"location":"backend/architecture/overview/#_3","title":"\u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0437\u0430\u043f\u0443\u0441\u043a\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432","text":"backend/project_setup.py<pre><code>class Apps(AppsCore):\n    \"\"\"\u041e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442 \u043f\u043e\u0440\u044f\u0434\u043e\u043a \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 \u043c\u043e\u0434\u0443\u043b\u0435\u0439.\"\"\"\n\n    services_before = [\n        \"logger\",                     # 1. \u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\n        \"dotorm_databases_postgres\",   # 2. DB Pool\n        \"security\",                    # 3. ACL, \u0440\u043e\u043b\u0438\n        \"auth_token\",                  # 4. \u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f\n    ]\n\n    services_after = [\n        \"dotorm_crud_auto\",           # 5. CRUD \u0440\u043e\u0443\u0442\u0435\u0440\u044b\n        \"chat\",                       # 6. WebSocket + PubSub\n    ]\n</code></pre> <p>\u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0432\u0430\u0436\u0435\u043d</p> <p><code>services_before</code> \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f \u0434\u043e \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432 \u2014 \u043e\u043d\u0438 \u043d\u0430\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u044e\u0442 DB pool, \u0431\u0435\u0437 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0440\u043e\u0443\u0442\u0435\u0440\u044b \u043d\u0435 \u043c\u043e\u0433\u0443\u0442 \u0440\u0430\u0431\u043e\u0442\u0430\u0442\u044c. <code>services_after</code> \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f \u043f\u043e\u0441\u043b\u0435 \u2014 \u043e\u043d\u0438 \u043c\u043e\u0433\u0443\u0442 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0440\u043e\u0443\u0442\u0435\u0440\u044b \u0438 \u0434\u0440\u0443\u0433\u0438\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b.</p>"},{"location":"backend/architecture/overview/#_4","title":"\u041c\u043e\u0434\u0443\u043b\u044c\u043d\u0430\u044f \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430","text":"<p>\u041a\u0430\u0436\u0434\u044b\u0439 CRM-\u043c\u043e\u0434\u0443\u043b\u044c \u2014 \u044d\u0442\u043e \u043f\u0430\u043f\u043a\u0430 \u0441 \u0444\u0438\u043a\u0441\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u0439 \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u043e\u0439:</p> <pre><code>backend/base/crm/chat/\n\u251c\u2500\u2500 app.py              # Service: startup/shutdown\n\u251c\u2500\u2500 models/             # DotModel-\u043a\u043b\u0430\u0441\u0441\u044b\n\u2502   \u251c\u2500\u2500 chat.py\n\u2502   \u251c\u2500\u2500 chat_message.py\n\u2502   \u2514\u2500\u2500 chat_member.py\n\u251c\u2500\u2500 routers/            # FastAPI \u0440\u043e\u0443\u0442\u0435\u0440\u044b\n\u2502   \u251c\u2500\u2500 chats.py\n\u2502   \u2514\u2500\u2500 messages.py\n\u251c\u2500\u2500 schemas/            # Pydantic-\u0441\u0445\u0435\u043c\u044b (\u0435\u0441\u043b\u0438 \u043d\u0443\u0436\u043d\u044b)\n\u2514\u2500\u2500 websocket/          # \u0414\u043e\u043f. \u043b\u043e\u0433\u0438\u043a\u0430 (WS, pubsub)\n</code></pre> <p>\u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u043c\u043e\u0434\u0443\u043b\u044f \u0432 <code>project_setup.py</code>:</p> backend/project_setup.py<pre><code>class Models(ModelsCore):\n    # \u041a\u0430\u0436\u0434\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 CRUD API \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\n    chat = Chat\n    chat_message = ChatMessage\n    chat_member = ChatMember\n    user = User\n    # ...\n</code></pre>"},{"location":"backend/architecture/overview/#request-lifecycle","title":"Request Lifecycle","text":"<pre><code>sequenceDiagram\n    participant C as Client\n    participant MW as Auth Middleware\n    participant R as Router\n    participant ORM as DotORM\n    participant DB as PostgreSQL\n\n    C-&gt;&gt;MW: POST /chats/1/messages\n    MW-&gt;&gt;MW: verify_access(token)\n    MW-&gt;&gt;MW: set_access_session(session)\n    MW-&gt;&gt;R: pin_message(req, chat_id, msg_id)\n    R-&gt;&gt;ORM: ChatMember.check_can_pin(...)\n    ORM-&gt;&gt;DB: SELECT ... FROM chat_members\n    DB--&gt;&gt;ORM: row\n    R-&gt;&gt;ORM: message.update(pinned=True)\n    ORM-&gt;&gt;DB: UPDATE chat_messages SET pinned=true\n    R-&gt;&gt;R: chat_manager.send_to_chat(ws_event)\n    R--&gt;&gt;C: {\"success\": true}</code></pre>"},{"location":"backend/architecture/services/","title":"Service \u2014 \u0431\u0430\u0437\u043e\u0432\u044b\u0439 \u043a\u043b\u0430\u0441\u0441 \u043c\u043e\u0434\u0443\u043b\u0435\u0439","text":"<p>\u041a\u0430\u0436\u0434\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c \u0432 FARA CRM \u2014 \u044d\u0442\u043e \u043d\u0430\u0441\u043b\u0435\u0434\u043d\u0438\u043a <code>Service</code> \u0438\u043b\u0438 \u0432 \u043f\u0440\u043e\u0441\u0442\u043e\u043c \u0441\u043b\u0443\u0447\u0430\u0435 <code>App</code>. Service \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0436\u0438\u0437\u043d\u0435\u043d\u043d\u044b\u043c \u0446\u0438\u043a\u043b\u043e\u043c \u043c\u043e\u0434\u0443\u043b\u044f: \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u043f\u0440\u0438 \u0441\u0442\u0430\u0440\u0442\u0435, cleanup \u043f\u0440\u0438 \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0435.</p>"},{"location":"backend/architecture/services/#_1","title":"\u0418\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441","text":"backend/base/system/core/service.py<pre><code>class Service(App):\n    \"\"\"\u0411\u0430\u0437\u043e\u0432\u044b\u0439 \u043a\u043b\u0430\u0441\u0441 \u0434\u043b\u044f \u0432\u0441\u0435\u0445 \u043c\u043e\u0434\u0443\u043b\u0435\u0439 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f.\"\"\"\n\n    info: dict = {}  # {\"name\": \"...\", \"depends\": [...]}\n\n    async def startup(self, app: FastAPI):\n        \"\"\"\u0412\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0437\u0430\u043f\u0443\u0441\u043a\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f.\"\"\"\n        ...\n\n    async def shutdown(self, app: FastAPI):\n        \"\"\"\u0412\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0435. \u041e\u0441\u0432\u043e\u0431\u043e\u0436\u0434\u0430\u0435\u0442 \u0440\u0435\u0441\u0443\u0440\u0441\u044b.\"\"\"\n        ...\n\n    async def post_init(self, app: FastAPI):\n        \"\"\"\u0412\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e\u0441\u043b\u0435 \u043f\u043e\u043b\u043d\u043e\u0439 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 \u0432\u0441\u0435\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432.\"\"\"\n        ...\n</code></pre>"},{"location":"backend/architecture/services/#_2","title":"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u0430","text":"backend/base/crm/chat/app.py<pre><code>class ChatApp(Service):\n    info = {\n        \"name\": \"Chat\",\n        \"depends\": [\"security\", \"dotorm_databases_postgres\"],  # (1)!\n    }\n\n    async def startup(self, app: FastAPI):\n        \"\"\"\u0417\u0430\u043f\u0443\u0441\u043a PubSub \u0434\u043b\u044f real-time \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439.\"\"\"\n        await super().startup(app)\n\n        env: Environment = app.state.env\n        settings = PubSubSettings()\n\n        backend = create_pubsub_backend(settings)\n        await backend.setup(pool=env.apps.db.fara)\n\n        chat_manager.set_pubsub(backend)\n        await backend.start_listening(chat_manager.handle_pubsub_event)\n\n    async def shutdown(self, app: FastAPI):\n        \"\"\"\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 PubSub, \u043e\u0441\u0432\u043e\u0431\u043e\u0436\u0434\u0435\u043d\u0438\u0435 LISTEN-\u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f.\"\"\"\n        if chat_manager.pubsub:\n            await chat_manager.pubsub.stop()    # (2)!\n            chat_manager.set_pubsub(None)\n\n    async def post_init(self, app: FastAPI):\n        \"\"\"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0441\u0438\u0441\u0442\u0435\u043c\u043d\u044b\u0445 \u0447\u0430\u0442\u043e\u0432 \u043f\u0440\u0438 \u043f\u0435\u0440\u0432\u043e\u043c \u0437\u0430\u043f\u0443\u0441\u043a\u0435.\"\"\"\n        await super().post_init(app)\n        # ...\u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e\n</code></pre> <ol> <li>\u0417\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0438 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u044e\u0442 \u043f\u043e\u0440\u044f\u0434\u043e\u043a \u0437\u0430\u043f\u0443\u0441\u043a\u0430. Chat \u0437\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 security \u0438 DB \u2014 \u043e\u043d\u0438 \u0431\u0443\u0434\u0443\u0442 \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u044b \u0440\u0430\u043d\u044c\u0448\u0435.</li> <li> \u0412\u0441\u0435\u0433\u0434\u0430 \u043e\u0441\u0432\u043e\u0431\u043e\u0436\u0434\u0430\u0439\u0442\u0435 \u0440\u0435\u0441\u0443\u0440\u0441\u044b \u0432 <code>shutdown()</code>. PubSub listener \u0434\u0435\u0440\u0436\u0438\u0442 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0438\u0437 \u043f\u0443\u043b\u0430 \u2014 \u0431\u0435\u0437 cleanup \u043f\u0443\u043b \u0443\u0442\u0435\u0447\u0451\u0442.</li> </ol>"},{"location":"backend/architecture/services/#_3","title":"\u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f","text":"<p>\u0421\u0435\u0440\u0432\u0438\u0441 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u0432 <code>project_setup.py</code> \u0447\u0435\u0440\u0435\u0437 <code>services_before</code> \u0438\u043b\u0438 <code>services_after</code>:</p> backend/project_setup.py<pre><code>class Apps(AppsCore):\n    services_before = [\n        \"logger\",\n        \"dotorm_databases_postgres\",\n        \"security\",\n        \"auth_token\",\n    ]\n\n    services_after = [\n        \"dotorm_crud_auto\",  # \u0430\u0432\u0442\u043e-CRUD \u043f\u043e\u0441\u043b\u0435 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432\n        \"chat\",              # WebSocket \u043f\u043e\u0441\u043b\u0435 \u043f\u043e\u043b\u043d\u043e\u0439 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438\n    ]\n\n    installed = [\n        \"backend.base.crm.chat\",         # \u043c\u043e\u0434\u0443\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0438\u043c\u0435\u0442\u044c app.py\n        \"backend.base.crm.security\",\n        \"backend.base.crm.users\",\n        # ...\n    ]\n</code></pre> <p>services_before vs services_after</p> <ul> <li><code>services_before</code> \u2014 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f \u0434\u043e \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432. \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0434\u043b\u044f \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b: DB, \u043b\u043e\u0433\u0433\u0435\u0440, auth.</li> <li><code>services_after</code> \u2014 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f \u043f\u043e\u0441\u043b\u0435 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432. \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0434\u043b\u044f \u043b\u043e\u0433\u0438\u043a\u0438, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0437\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 \u0440\u043e\u0443\u0442\u0435\u0440\u043e\u0432 (CRUD auto, WebSocket).</li> </ul>"},{"location":"backend/architecture/services/#handler-errors","title":"Handler Errors","text":"<p>\u0421\u0435\u0440\u0432\u0438\u0441 \u043c\u043e\u0436\u0435\u0442 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u0438 \u043e\u0448\u0438\u0431\u043e\u043a:</p> <pre><code>class AuthTokenApp(Service):\n    def handler_errors(self, app_server: FastAPI):\n        async def catch_auth_error(request, exc):\n            return JSONResponse(\n                content={\"error\": \"#FORBIDDEN\"},\n                status_code=401,\n            )\n\n        app_server.add_exception_handler(\n            SessionNotExist, catch_auth_error\n        )\n</code></pre>"},{"location":"backend/dotorm/","title":"DotORM","text":"<p>\u0410\u0441\u0438\u043d\u0445\u0440\u043e\u043d\u043d\u044b\u0439 ORM \u0434\u043b\u044f PostgreSQL, Mysql, Clickhouse, \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0435\u0446\u0438\u0430\u043b\u044c\u043d\u043e \u0434\u043b\u044f FARA CRM.</p>"},{"location":"backend/dotorm/#orm","title":"\u041f\u043e\u0447\u0435\u043c\u0443 \u0441\u0432\u043e\u0439 ORM?","text":"<ul> <li>\u041f\u043e\u043b\u043d\u044b\u0439 async \u2014 \u043d\u0430\u0442\u0438\u0432\u043d\u0430\u044f \u0440\u0430\u0431\u043e\u0442\u0430 \u0441 asyncpg, \u0431\u0435\u0437 sync-\u043e\u0431\u0451\u0440\u0442\u043e\u043a</li> <li>\u0410\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f CRUD API \u2014 \u043c\u043e\u0434\u0435\u043b\u044c \u2192 REST API \u0437\u0430 0 \u0441\u0442\u0440\u043e\u043a \u043a\u043e\u0434\u0430</li> <li>\u0414\u0435\u043a\u043b\u0430\u0440\u0430\u0442\u0438\u0432\u043d\u044b\u0435 \u0441\u0432\u044f\u0437\u0438 \u2014 Many2one, One2many, Many2many \u0441 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u043c JOIN</li> <li>\u0410\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f DDL \u2014 <code>CREATE TABLE</code> \u0438\u0437 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u044f \u043c\u043e\u0434\u0435\u043b\u0438</li> <li>Access Control \u2014 \u0432\u0441\u0442\u0440\u043e\u0435\u043d\u043d\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u0440\u0430\u0432 \u043d\u0430 \u0443\u0440\u043e\u0432\u043d\u0435 ORM</li> </ul>"},{"location":"backend/dotorm/#_1","title":"\u0411\u044b\u0441\u0442\u0440\u044b\u0439 \u043f\u0440\u0438\u043c\u0435\u0440","text":"<pre><code>from backend.base.system.dotorm.dotorm.model import DotModel\nfrom backend.base.system.dotorm.dotorm.fields import (\n    Char, Text, Boolean, Many2one, One2many\n)\n\n\nclass Chat(DotModel):\n    __table__ = \"chats\"\n\n    name: str = Char(max_length=255, required=True)\n    description: str = Text()\n    is_archived: bool = Boolean(default=False)\n    creator_id: \"User\" = Many2one[\"User\"](\n        relation_table=\"users\",\n        required=True,\n    )\n    messages: list[\"ChatMessage\"] = One2many[\"ChatMessage\"](\n        relation_table=\"chat_messages\",\n        relation_table_field=\"chat_id\",\n    )\n</code></pre> <pre><code># \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435\nchat_id = await Chat.create(Chat(name=\"General\", creator_id=1))\n# \u0438\u043b\u0438 \u0447\u0442\u043e \u043b\u0443\u0447\u0448\u0435\nchat_id = await Chat.create(Chat(name=\"General\", creator_id=User(id=1)))\n\n# \u0427\u0442\u0435\u043d\u0438\u0435\nchat = await Chat.get(chat_id)\nchat = await Chat.get(chat_id, fields=[\"name\", \"is_archived\"])\n# \u0438\u043b\u0438 \u0435\u0441\u043b\u0438 \u043d\u0443\u0436\u043d\u044b \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u044b\u0435 \u043f\u043e\u043b\u044f \u0437\u0430 \u0437\u0430\u043f\u0440\u043e\u0441 \u0442\u043e\nchat = await Chat.get(chat_id,\n    fields=[\"name\", \"is_archived\"], \n    nested_fields={\"creator_id\":[\"name\", \"id\"]}\n    )\n\n# \u041f\u043e\u0438\u0441\u043a\nchats = await Chat.search(\n    filter=[(\"is_archived\", \"=\", False)],\n    fields=[\"id\", \"name\"],\n    order=\"id\",\n    sort=\"desc\",\n    limit=20,\n)\n\n# \u041e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435\nawait chat.update(Chat(name=\"New Name\"))\n\n# \u0423\u0434\u0430\u043b\u0435\u043d\u0438\u0435\nawait chat.delete()\n</code></pre>"},{"location":"backend/dotorm/#_2","title":"\u0420\u0430\u0437\u0434\u0435\u043b\u044b","text":"<ul> <li>\u041c\u043e\u0434\u0435\u043b\u0438 \u2014 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0435\u0439, <code>DotModel</code>, <code>__table__</code></li> <li>\u041f\u043e\u043b\u044f \u2014 \u0442\u0438\u043f\u044b \u043f\u043e\u043b\u0435\u0439, \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b, \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e</li> <li>\u0417\u0430\u043f\u0440\u043e\u0441\u044b \u2014 <code>search</code>, <code>get</code>, <code>create</code>, <code>update</code>, <code>delete</code></li> <li>\u0421\u0432\u044f\u0437\u0438 \u2014 Many2one, One2many, Many2many</li> <li>CRUD Auto \u2014 \u0430\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f REST API</li> </ul>"},{"location":"backend/dotorm/crud-auto/","title":"CRUD Auto \u2014 \u0430\u0432\u0442\u043e\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f REST API","text":"<p>\u041a\u0430\u0436\u0434\u0430\u044f \u0437\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u043f\u043e\u043b\u043d\u044b\u0439 \u043d\u0430\u0431\u043e\u0440 REST-\u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442\u043e\u0432. \u041d\u043e\u043b\u044c \u0441\u0442\u0440\u043e\u043a \u043a\u043e\u0434\u0430 \u2014 \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0438.</p>"},{"location":"backend/dotorm/crud-auto/#_1","title":"\u0413\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u043c\u044b\u0435 \u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442\u044b","text":"<p>\u0414\u043b\u044f \u043c\u043e\u0434\u0435\u043b\u0438 \u0441 <code>__route__ = \"products\"</code>:</p> \u041c\u0435\u0442\u043e\u0434 URL \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 POST <code>/products/search</code> \u041f\u043e\u0438\u0441\u043a \u0441 \u0444\u0438\u043b\u044c\u0442\u0440\u0430\u043c\u0438 \u0438 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0435\u0439 POST <code>/products/create</code> \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438 GET <code>/products/read/{id}</code> \u0427\u0442\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438 \u043f\u043e ID PATCH <code>/products/update/{id}</code> \u041e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438 DELETE <code>/products/delete</code> \u0423\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0435\u0439 GET <code>/products/read_default_values</code> \u0417\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e"},{"location":"backend/dotorm/crud-auto/#_2","title":"\u041a\u0430\u043a \u044d\u0442\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442","text":"<pre><code>graph LR\n    M[DotModel] --&gt; SR[SchemaRegistry]\n    SR --&gt; PS[Pydantic Schemas]\n    PS --&gt; CR[CRUDRouterGenerator]\n    CR --&gt; R[FastAPI Routers]\n\n    style M fill:#e3f2fd\n    style R fill:#e8f5e9</code></pre> <ol> <li>SchemaRegistry \u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0432\u0441\u0435 \u043f\u043e\u043b\u044f \u043c\u043e\u0434\u0435\u043b\u0438</li> <li>\u0413\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u0442 Pydantic-\u0441\u0445\u0435\u043c\u044b \u0434\u043b\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 (create, update, read, search)</li> <li>CRUDRouterGenerator \u0441\u043e\u0437\u0434\u0430\u0451\u0442 FastAPI-\u0440\u043e\u0443\u0442\u0435\u0440\u044b \u0441 \u044d\u0442\u0438\u043c\u0438 \u0441\u0445\u0435\u043c\u0430\u043c\u0438</li> <li>\u0420\u043e\u0443\u0442\u0435\u0440\u044b \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u044e\u0442\u0441\u044f \u043a \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044e \u043f\u0440\u0438 \u0441\u0442\u0430\u0440\u0442\u0435</li> </ol>"},{"location":"backend/dotorm/crud-auto/#search-api","title":"Search API","text":"<pre><code>POST /products/search\nContent-Type: application/json\n\n{\n    \"filter\": [\n        [\"active\", \"=\", true],\n        [\"price\", \"&gt;\", 100]\n    ],\n    \"fields\": [\"id\", \"name\", \"price\", \"category_id\"],\n    \"order\": \"price\",\n    \"sort\": \"desc\",\n    \"start\": 0,\n    \"end\": 20,\n    \"limit\": 20\n}\n</code></pre> <p>\u041e\u0442\u0432\u0435\u0442:</p> <pre><code>{\n    \"data\": [\n        {\"id\": 5, \"name\": \"Widget Pro\", \"price\": 299, \"category_id\": 2},\n        {\"id\": 3, \"name\": \"Widget Basic\", \"price\": 199, \"category_id\": 1}\n    ],\n    \"total\": 42\n}\n</code></pre>"},{"location":"backend/dotorm/crud-auto/#create-api","title":"Create API","text":"<pre><code>POST /products/create\nContent-Type: application/json\n\n{\n    \"name\": \"New Product\",\n    \"price\": 199.99,\n    \"category_id\": 1,\n    \"active\": true\n}\n</code></pre> <p>\u041e\u0442\u0432\u0435\u0442:</p> <pre><code>{\n    \"data\": {\"id\": 43}\n}\n</code></pre>"},{"location":"backend/dotorm/crud-auto/#read-api","title":"Read API","text":"<pre><code>GET /products/read/43?fields=id,name,price,category_id\n</code></pre> <p>\u041e\u0442\u0432\u0435\u0442:</p> <pre><code>{\n    \"data\": {\n        \"id\": 43,\n        \"name\": \"New Product\",\n        \"price\": 199.99,\n        \"category_id\": {\"id\": 1, \"name\": \"Electronics\"}\n    }\n}\n</code></pre>"},{"location":"backend/dotorm/crud-auto/#update-api","title":"Update API","text":"<pre><code>PATCH /products/update/43\nContent-Type: application/json\n\n{\n    \"price\": 249.99,\n    \"name\": \"Updated Product\"\n}\n</code></pre>"},{"location":"backend/dotorm/crud-auto/#_3","title":"\u041a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u044b","text":"<p>\u0414\u043b\u044f \u043c\u043e\u0434\u0443\u043b\u0435\u0439, \u043a\u043e\u0442\u043e\u0440\u044b\u043c \u043d\u0443\u0436\u043d\u0430 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u043b\u043e\u0433\u0438\u043a\u0430, \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0439 \u043e\u0431\u044b\u0447\u043d\u044b\u0435 FastAPI-\u0440\u043e\u0443\u0442\u0435\u0440\u044b:</p> backend/base/crm/chat/routers/messages.py<pre><code>from fastapi import APIRouter, Request\n\nrouter_private = APIRouter(\n    prefix=\"/chats\",\n    tags=[\"Chat Messages\"],\n)\n\n@router_private.post(\"/{chat_id}/messages\")\nasync def send_message(req: Request, chat_id: int, body: MessageCreate):\n    \"\"\"\u041a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0439 \u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442 \u0441 \u0431\u0438\u0437\u043d\u0435\u0441-\u043b\u043e\u0433\u0438\u043a\u043e\u0439.\"\"\"\n    env = req.app.state.env\n\n    # \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u0440\u0430\u0432\n    await ChatMember.check_can_write(chat_id, user_id)\n\n    # \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 ORM\n    msg_id = await env.models.chat_message.create(\n        env.models.chat_message(\n            chat_id=chat_id,\n            author_user_id=user_id,\n            body=body.body,\n        )\n    )\n\n    # WebSocket \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435\n    await chat_manager.send_to_chat(chat_id, {...})\n\n    return {\"data\": {\"id\": msg_id}}\n</code></pre> <p>CRUD Auto + \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u044b</p> <p>\u041c\u043e\u0434\u0435\u043b\u044c \u043c\u043e\u0436\u0435\u0442 \u043e\u0434\u043d\u043e\u0432\u0440\u0435\u043c\u0435\u043d\u043d\u043e \u0438\u043c\u0435\u0442\u044c \u0430\u0432\u0442\u043e-CRUD \u0440\u043e\u0443\u0442\u044b \u0438 \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u044b. \u0410\u0432\u0442\u043e-CRUD \u043f\u043e\u043a\u0440\u044b\u0432\u0430\u0435\u0442 \u0431\u0430\u0437\u043e\u0432\u044b\u0435 \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u0438, \u0430 \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u2014 \u0431\u0438\u0437\u043d\u0435\u0441-\u043b\u043e\u0433\u0438\u043a\u0443 (\u0447\u0430\u0442, \u0442\u0440\u0430\u043d\u0437\u0430\u043a\u0446\u0438\u0438, \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u044f).</p>"},{"location":"backend/dotorm/fields/","title":"\u041f\u043e\u043b\u044f (Fields)","text":"<p>\u041f\u043e\u043b\u044f \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u044e\u0442 \u0442\u0438\u043f\u044b \u043a\u043e\u043b\u043e\u043d\u043e\u043a \u0438 \u0438\u0445 \u043f\u043e\u0432\u0435\u0434\u0435\u043d\u0438\u0435. \u041a\u0430\u0436\u0434\u043e\u0435 \u043f\u043e\u043b\u0435 \u2014 \u044d\u0442\u043e \u0434\u0435\u0441\u043a\u0440\u0438\u043f\u0442\u043e\u0440 Python, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0435\u0439, \u0441\u0435\u0440\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0435\u0439 \u0438 DDL-\u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0435\u0439.</p>"},{"location":"backend/dotorm/fields/#_1","title":"\u0421\u043a\u0430\u043b\u044f\u0440\u043d\u044b\u0435 \u043f\u043e\u043b\u044f","text":""},{"location":"backend/dotorm/fields/#integer-biginteger-smallinteger","title":"Integer / BigInteger / SmallInteger","text":"<pre><code>from backend.base.system.dotorm.dotorm.fields import (\n    Integer, BigInteger, SmallInteger\n)\n\nclass Product(DotModel):\n    __table__ = \"products\"\n\n    quantity: int = Integer(default=0)\n    price_cents: int = BigInteger()\n    sort_order: int = SmallInteger(default=0)\n</code></pre> \u041f\u043e\u043b\u0435 PostgreSQL Python <code>Integer</code> <code>INTEGER</code> <code>int</code> <code>BigInteger</code> <code>BIGINT</code> <code>int</code> <code>SmallInteger</code> <code>SMALLINT</code> <code>int</code>"},{"location":"backend/dotorm/fields/#char-text","title":"Char / Text","text":"<pre><code>from backend.base.system.dotorm.dotorm.fields import Char, Text\n\nclass User(DotModel):\n    __table__ = \"users\"\n\n    name: str = Char(max_length=255, required=True)   # VARCHAR(255) NOT NULL\n    login: str = Char(max_length=100, unique=True)     # VARCHAR(100) UNIQUE\n    bio: str = Text()                                   # TEXT\n</code></pre>"},{"location":"backend/dotorm/fields/#boolean","title":"Boolean","text":"<pre><code>is_active: bool = Boolean(default=True)     # BOOLEAN DEFAULT true\nis_deleted: bool = Boolean(default=False)\n</code></pre>"},{"location":"backend/dotorm/fields/#datetime-date-time","title":"Datetime / Date / Time","text":"<pre><code>from backend.base.system.dotorm.dotorm.fields import Datetime, Date, Time\n\nclass Task(DotModel):\n    __table__ = \"tasks\"\n\n    due_date: date = Date()                              # DATE\n    reminder_time: time = Time()                         # TIME\n    created_at: datetime = Datetime(default=\"now\")           # TIMESTAMPTZ DEFAULT now()\n    updated_at: datetime = Datetime(default=\"now\")\n</code></pre>"},{"location":"backend/dotorm/fields/#float-decimal","title":"Float / Decimal","text":"<pre><code>from backend.base.system.dotorm.dotorm.fields import Float, Decimal\n\nweight: float = Float()                                   # FLOAT\nprice: float = Decimal(precision=10, scale=2)             # NUMERIC(10, 2)\n</code></pre>"},{"location":"backend/dotorm/fields/#jsonfield","title":"JSONField","text":"<pre><code>from backend.base.system.dotorm.dotorm.fields import JSONField\n\nmetadata: list | dict = JSONField(default={})      # JSONB DEFAULT '{}'\ntags: list | dict = JSONField(default=[])          # JSONB DEFAULT '[]'\n</code></pre> <p>asyncpg \u0438 JSONB</p> <p>asyncpg \u043d\u0435 \u0434\u0435\u0441\u0435\u0440\u0438\u0430\u043b\u0438\u0437\u0443\u0435\u0442 JSONB \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438. DotORM \u0434\u0435\u043b\u0430\u0435\u0442 <code>json.loads()</code> \u043f\u0440\u0438 \u0447\u0442\u0435\u043d\u0438\u0438, \u0435\u0441\u043b\u0438 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043f\u0440\u0438\u0448\u043b\u043e \u0441\u0442\u0440\u043e\u043a\u043e\u0439.</p>"},{"location":"backend/dotorm/fields/#selection","title":"Selection","text":"<p>\u041f\u043e\u043b\u0435 \u0441 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u043d\u044b\u043c \u043d\u0430\u0431\u043e\u0440\u043e\u043c \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0439:</p> <pre><code>from backend.base.system.dotorm.dotorm.fields import Selection\n\nclass Chat(DotModel):\n    __table__ = \"chats\"\n\n    chat_type: str = Selection(\n        selection=[\n            (\"direct\", \"\u041b\u0438\u0447\u043d\u044b\u0439\"),\n            (\"group\", \"\u0413\u0440\u0443\u043f\u043f\u0430\"),\n            (\"channel\", \"\u041a\u0430\u043d\u0430\u043b\"),\n            (\"record\", \"\u0427\u0430\u0442 \u0437\u0430\u043f\u0438\u0441\u0438\"),\n        ],\n        default=\"group\",\n        required=True,\n    )\n</code></pre> <p>\u0412 PostgreSQL \u044d\u0442\u043e <code>VARCHAR</code> \u0441 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0435\u0439 \u043d\u0430 \u0443\u0440\u043e\u0432\u043d\u0435 ORM. \u0417\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u0445\u0440\u0430\u043d\u044f\u0442\u0441\u044f \u043a\u0430\u043a \u0441\u0442\u0440\u043e\u043a\u0438 (<code>\"direct\"</code>, <code>\"group\"</code>, ...).</p>"},{"location":"backend/dotorm/fields/#_2","title":"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u043f\u043e\u043b\u0435\u0439","text":"<p>\u0412\u0441\u0435 \u043f\u043e\u043b\u044f \u043d\u0430\u0441\u043b\u0435\u0434\u0443\u044e\u0442 \u043e\u0431\u0449\u0438\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u043e\u0442 \u0431\u0430\u0437\u043e\u0432\u043e\u0433\u043e <code>Field</code>:</p> \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 \u0422\u0438\u043f \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>required</code> <code>bool</code> <code>False</code> <code>NOT NULL</code> \u0432 DDL <code>default</code> <code>any</code> <code>None</code> \u0417\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e <code>unique</code> <code>bool</code> <code>False</code> <code>UNIQUE</code> constraint <code>index</code> <code>bool</code> <code>False</code> \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0438\u043d\u0434\u0435\u043a\u0441 <code>store</code> <code>bool</code> <code>True</code> \u0425\u0440\u0430\u043d\u0438\u0442\u044c \u0432 \u0411\u0414 (False \u0434\u043b\u044f computed) <code>readonly</code> <code>bool</code> <code>False</code> \u041d\u0435 \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0442\u044c \u0447\u0435\u0440\u0435\u0437 API <pre><code>name: str = Char(\n    max_length=255,\n    required=True,       # NOT NULL\n    unique=True,         # UNIQUE\n    index=True,          # CREATE INDEX\n)\n\ncreated_at: datetime = Datetime(\n    default=\"now\",\n    readonly=True,       # \u043d\u0435\u043b\u044c\u0437\u044f \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u0447\u0435\u0440\u0435\u0437 API\n)\n</code></pre>"},{"location":"backend/dotorm/fields/#_3","title":"\u041f\u043e\u043b\u044f \u0441\u0432\u044f\u0437\u0435\u0439","text":""},{"location":"backend/dotorm/fields/#many2one-fk","title":"Many2one (FK)","text":"<p>\u0412\u043d\u0435\u0448\u043d\u0438\u0439 \u043a\u043b\u044e\u0447 \u2014 \u0441\u0441\u044b\u043b\u043a\u0430 \u043d\u0430 \u043e\u0434\u043d\u0443 \u0437\u0430\u043f\u0438\u0441\u044c \u0434\u0440\u0443\u0433\u043e\u0439 \u0442\u0430\u0431\u043b\u0438\u0446\u044b:</p> <pre><code>from backend.base.system.dotorm.dotorm.fields import Many2one\n\nclass ChatMessage(DotModel):\n    __table__ = \"chat_messages\"\n\n    # FK \u2192 chats.id\n    chat_id: \"Chat\" = Many2one[\"Chat\"](\n        relation_table=\"chats\",\n        required=True,\n    )\n\n    # FK \u2192 users.id (nullable)\n    author_user_id: \"User\" = Many2one[\"User\"](\n        relation_table=\"users\",\n    )\n</code></pre> <p>\u041f\u0440\u0438 \u0447\u0442\u0435\u043d\u0438\u0438:</p> <pre><code>msg = await ChatMessage.get(1)\nmsg.chat_id       # int (FK value) \u2014 \u043f\u0440\u0438 \u043e\u0431\u044b\u0447\u043d\u043e\u043c \u0447\u0442\u0435\u043d\u0438\u0438\nmsg.chat_id.name  # str \u2014 \u043f\u0440\u0438 \u0447\u0442\u0435\u043d\u0438\u0438 \u0441 nested fields\n</code></pre>"},{"location":"backend/dotorm/fields/#one2many","title":"One2many","text":"<p>\u041e\u0431\u0440\u0430\u0442\u043d\u0430\u044f \u0441\u0432\u044f\u0437\u044c \u2014 \u0441\u043f\u0438\u0441\u043e\u043a \u0434\u043e\u0447\u0435\u0440\u043d\u0438\u0445 \u0437\u0430\u043f\u0438\u0441\u0435\u0439:</p> <pre><code>from backend.base.system.dotorm.dotorm.fields import One2many\n\nclass Chat(DotModel):\n    __table__ = \"chats\"\n\n    messages: list[\"ChatMessage\"] = One2many[\"ChatMessage\"](\n        relation_table=\"chat_messages\",      # \u0442\u0430\u0431\u043b\u0438\u0446\u0430 \u0434\u043e\u0447\u0435\u0440\u043d\u0438\u0445 \u0437\u0430\u043f\u0438\u0441\u0435\u0439\n        relation_table_field=\"chat_id\",      # FK \u0432 \u0434\u043e\u0447\u0435\u0440\u043d\u0435\u0439 \u0442\u0430\u0431\u043b\u0438\u0446\u0435\n    )\n</code></pre> <p>One2many \u043d\u0435 \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u043a\u043e\u043b\u043e\u043d\u043a\u0443</p> <p><code>One2many</code> \u2014 \u0432\u0438\u0440\u0442\u0443\u0430\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435. \u041e\u043d\u043e \u043d\u0435 \u0433\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u0442 \u043a\u043e\u043b\u043e\u043d\u043a\u0443 \u0432 \u0411\u0414, \u0430 \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442 \u0441\u0432\u044f\u0437\u044c \u0434\u043b\u044f \u0447\u0442\u0435\u043d\u0438\u044f.</p>"},{"location":"backend/dotorm/fields/#many2many","title":"Many2many","text":"<p>\u0421\u0432\u044f\u0437\u044c \u043c\u043d\u043e\u0433\u0438\u0435-\u043a\u043e-\u043c\u043d\u043e\u0433\u0438\u043c \u0447\u0435\u0440\u0435\u0437 \u043f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u0443\u044e \u0442\u0430\u0431\u043b\u0438\u0446\u0443:</p> <pre><code>from backend.base.system.dotorm.dotorm.fields import Many2many\n\nclass User(DotModel):\n    __table__ = \"users\"\n\n    role_ids: list[\"Role\"] = Many2many[\"Role\"](\n        relation_table=\"roles\",              # \u0446\u0435\u043b\u0435\u0432\u0430\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u0430\n        many2many_table=\"user_roles\",        # \u043f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u0430\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u0430\n        column1=\"user_id\",                   # FK \u043d\u0430 \u0442\u0435\u043a\u0443\u0449\u0443\u044e \u043c\u043e\u0434\u0435\u043b\u044c\n        column2=\"role_id\",                   # FK \u043d\u0430 \u0446\u0435\u043b\u0435\u0432\u0443\u044e \u043c\u043e\u0434\u0435\u043b\u044c\n    )\n</code></pre> <p>\u041f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u0430\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u0430 \u0441\u043e\u0437\u0434\u0430\u0451\u0442\u0441\u044f \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438:</p> <pre><code>CREATE TABLE IF NOT EXISTS user_roles (\n    user_id INTEGER REFERENCES users(id),\n    role_id INTEGER REFERENCES roles(id),\n    PRIMARY KEY (user_id, role_id)\n);\n</code></pre>"},{"location":"backend/dotorm/fields/#one2one","title":"One2one","text":"<p>\u0421\u0432\u044f\u0437\u044c \u043e\u0434\u0438\u043d-\u043a-\u043e\u0434\u043d\u043e\u043c\u0443:</p> <pre><code>from backend.base.system.dotorm.dotorm.fields import One2one\n\nclass User(DotModel):\n    __table__ = \"users\"\n\n    profile: \"UserProfile\" = One2one[\"UserProfile\"](\n        relation_table=\"user_profiles\",\n        relation_table_field=\"user_id\",\n    )\n</code></pre>"},{"location":"backend/dotorm/models/","title":"\u041c\u043e\u0434\u0435\u043b\u0438","text":"<p>\u041c\u043e\u0434\u0435\u043b\u044c \u2014 \u044d\u0442\u043e Python-\u043a\u043b\u0430\u0441\u0441, \u043d\u0430\u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 <code>DotModel</code>. \u041a\u0430\u0436\u0434\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u043e\u0434\u043d\u043e\u0439 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043d\u043d\u044b\u0445.</p>"},{"location":"backend/dotorm/models/#_2","title":"\u041e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0438","text":"backend/base/crm/chat/models/chat_message.py<pre><code>from backend.base.system.dotorm.dotorm.model import DotModel\nfrom backend.base.system.dotorm.dotorm.fields import (\n    Integer, Char, Text, Boolean, Datetime, Many2one\n)\n\n\nclass ChatMessage(DotModel):\n    __table__ = \"chat_messages\"       # (1)!\n    __route__ = \"chat_messages\"       # (2)!\n\n    chat_id = Many2one[\"Chat\"](       # (3)!\n        relation_table=\"chats\",\n        required=True,\n    )\n    author_user_id = Many2one[\"User\"](\n        relation_table=\"users\",\n        required=True,\n    )\n    body = Text()\n    is_edited = Boolean(default=False)\n    is_deleted = Boolean(default=False)\n    pinned = Boolean(default=False)\n    is_read = Boolean(default=True)\n    reply_to_id = Many2one[\"ChatMessage\"](\n        relation_table=\"chat_messages\",\n    )\n</code></pre> <ol> <li>\u0418\u043c\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u044b \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043d\u043d\u044b\u0445. \u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435.</li> <li>\u0418\u043c\u044f \u0434\u043b\u044f \u0430\u0432\u0442\u043e-\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u0433\u043e CRUD \u0440\u043e\u0443\u0442\u0430 (<code>/chat_messages/search</code>, <code>/chat_messages/create</code>, ...). \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u0440\u0430\u0432\u043d\u043e <code>__table__</code>.</li> <li>\u0412\u043d\u0435\u0448\u043d\u0438\u0439 \u043a\u043b\u044e\u0447. \u0413\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u0442 \u043a\u043e\u043b\u043e\u043d\u043a\u0443 <code>chat_id INTEGER REFERENCES chats(id)</code>.</li> </ol>"},{"location":"backend/dotorm/models/#-","title":"\u041c\u0435\u0442\u0430-\u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044b","text":"\u0410\u0442\u0440\u0438\u0431\u0443\u0442 \u0422\u0438\u043f \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>__table__</code> <code>str</code> \u2014 \u0418\u043c\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u044b \u0432 \u0411\u0414 (\u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e) <code>__route__</code> <code>str</code> <code>__table__</code> \u041f\u0440\u0435\u0444\u0438\u043a\u0441 REST API \u0440\u043e\u0443\u0442\u0430 <code>__access__</code> <code>dict</code> <code>{}</code> \u041f\u0440\u0430\u0432\u0438\u043b\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u0430 (ACL)"},{"location":"backend/dotorm/models/#_3","title":"\u0412\u0441\u0442\u0440\u043e\u0435\u043d\u043d\u044b\u0435 \u043f\u043e\u043b\u044f","text":"<p>\u041a\u0430\u0436\u0434\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u043f\u043e\u043b\u0435 <code>id</code>:</p> <pre><code>class DotModel:\n    id = Integer(primary_key=True)  # AUTO INCREMENT\n</code></pre> <p>id \u0432\u0441\u0435\u0433\u0434\u0430 \u0435\u0441\u0442\u044c</p> <p>\u041d\u0435 \u043d\u0443\u0436\u043d\u043e \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0442\u044c <code>id</code> \u0432 \u043c\u043e\u0434\u0435\u043b\u0438 \u2014 \u043e\u043d \u043d\u0430\u0441\u043b\u0435\u0434\u0443\u0435\u0442\u0441\u044f \u0438\u0437 <code>DotModel</code>.</p>"},{"location":"backend/dotorm/models/#_4","title":"\u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u043c\u043e\u0434\u0435\u043b\u0438","text":"<p>\u041c\u043e\u0434\u0435\u043b\u044c \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u0432 <code>project_setup.py</code>:</p> backend/project_setup.py<pre><code>class Models(ModelsCore):\n    chat = Chat\n    chat_message = ChatMessage\n    chat_member = ChatMember\n</code></pre> <p>\u041f\u043e\u0441\u043b\u0435 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043c\u043e\u0434\u0435\u043b\u044c \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0430 \u0447\u0435\u0440\u0435\u0437 <code>env.models.chat_message</code> \u0438 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442:</p> <ul> <li>CRUD API \u0440\u043e\u0443\u0442\u044b (<code>/chat_messages/search</code>, <code>/chat_messages/create</code>, ...)</li> <li>Pydantic-\u0441\u0445\u0435\u043c\u044b \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438</li> <li>DDL \u0434\u043b\u044f \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0442\u0430\u0431\u043b\u0438\u0446\u044b</li> </ul>"},{"location":"backend/dotorm/models/#_5","title":"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u044d\u043a\u0437\u0435\u043c\u043f\u043b\u044f\u0440\u0430","text":"<p>\u042d\u043a\u0437\u0435\u043c\u043f\u043b\u044f\u0440 \u043c\u043e\u0434\u0435\u043b\u0438 \u2014 \u044d\u0442\u043e \u043d\u0430\u0431\u043e\u0440 \u0434\u0430\u043d\u043d\u044b\u0445, \u0430 \u043d\u0435 ORM-\u0437\u0430\u043f\u0438\u0441\u044c. \u041e\u043d \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f \u043a\u0430\u043a payload \u0434\u043b\u044f <code>create()</code> \u0438 <code>update()</code>:</p> <pre><code># Payload \u0434\u043b\u044f \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f (\u043d\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0451\u043d\u043d\u044b\u0439 \u0432 \u0411\u0414)\nmsg = ChatMessage(\n    chat_id=1,\n    author_user_id=42,\n    body=\"Hello!\",\n)\n\n# \u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u2192 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c id\nmsg_id = await ChatMessage.create(msg)\n\n# \u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0438\u0437 \u0411\u0414 \u2192 \u043f\u043e\u043b\u043d\u043e\u0446\u0435\u043d\u043d\u0430\u044f \u0437\u0430\u043f\u0438\u0441\u044c\nmsg = await ChatMessage.get(msg_id)\nmsg.body       # \"Hello!\"\nmsg.is_edited  # False (default)\nmsg.id         # msg_id\n</code></pre>"},{"location":"backend/dotorm/models/#classmethod-vs-instance","title":"Classmethod vs Instance","text":"\u041c\u0435\u0442\u043e\u0434 \u0422\u0438\u043f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>Model.create(payload)</code> classmethod \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0437\u0430\u043f\u0438\u0441\u044c <code>Model.get(id)</code> classmethod \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u043e ID <code>Model.search(...)</code> classmethod \u041f\u043e\u0438\u0441\u043a \u0441 \u0444\u0438\u043b\u044c\u0442\u0440\u0430\u043c\u0438 <code>record.update(payload)</code> instance \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0437\u0430\u043f\u0438\u0441\u044c <code>record.delete()</code> instance \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0437\u0430\u043f\u0438\u0441\u044c <pre><code># Classmethod \u2014 \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u043a\u043b\u0430\u0441\u0441\u0435\nchat = await Chat.get(1)\nchats = await Chat.search(filter=[(\"is_archived\", \"=\", False)])\n\n# Instance \u2014 \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043d\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438\nawait chat.update(Chat(name=\"New name\"))\nawait chat.delete()\n</code></pre>"},{"location":"backend/dotorm/models/#ddl","title":"DDL \u2014 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0442\u0430\u0431\u043b\u0438\u0446","text":"<p>\u041f\u0440\u0438 \u043f\u0435\u0440\u0432\u043e\u043c \u0437\u0430\u043f\u0443\u0441\u043a\u0435 DotORM \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u0442\u0430\u0431\u043b\u0438\u0446\u044b:</p> <pre><code># \u0412\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043e\u0434\u0438\u043d \u0440\u0430\u0437 \u043f\u0440\u0438 \u0441\u0442\u0430\u0440\u0442\u0435\nasync with ContainerTransaction(pool) as session:\n    for model in all_models:\n        foreign_keys = await model.__create_table__(session)\n</code></pre> <p>\u0413\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u043c\u044b\u0439 SQL:</p> <pre><code>CREATE TABLE IF NOT EXISTS chat_messages (\n    id SERIAL PRIMARY KEY,\n    chat_id INTEGER NOT NULL REFERENCES chats(id),\n    author_user_id INTEGER NOT NULL REFERENCES users(id),\n    body TEXT,\n    is_edited BOOLEAN DEFAULT false,\n    is_deleted BOOLEAN DEFAULT false,\n    pinned BOOLEAN DEFAULT false,\n    is_read BOOLEAN DEFAULT true,\n    reply_to_id INTEGER REFERENCES chat_messages(id)\n);\n</code></pre>"},{"location":"backend/dotorm/queries/","title":"\u0417\u0430\u043f\u0440\u043e\u0441\u044b","text":""},{"location":"backend/dotorm/queries/#search","title":"search \u2014 \u043f\u043e\u0438\u0441\u043a \u0441 \u0444\u0438\u043b\u044c\u0442\u0440\u0430\u043c\u0438","text":"<p>\u041e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 \u043c\u0435\u0442\u043e\u0434 \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0441\u043f\u0438\u0441\u043a\u0430 \u0437\u0430\u043f\u0438\u0441\u0435\u0439:</p> <pre><code>results = await Chat.search(\n    filter=[\n        (\"is_archived\", \"=\", False),\n        (\"chat_type\", \"in\", [\"group\", \"channel\"]),\n    ],\n    fields=[\"id\", \"name\", \"chat_type\", \"creator_id\"],\n    order=\"id\",\n    sort=\"desc\",\n    limit=20,\n    offset=0,\n)\n# results: list[Chat]\n</code></pre>"},{"location":"backend/dotorm/queries/#_2","title":"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b","text":"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 \u0422\u0438\u043f \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>filter</code> <code>list[tuple]</code> <code>[]</code> \u0424\u0438\u043b\u044c\u0442\u0440\u044b <code>(field, operator, value)</code> <code>fields</code> <code>list[str]</code> \u0432\u0441\u0435 store-\u043f\u043e\u043b\u044f \u041a\u0430\u043a\u0438\u0435 \u043f\u043e\u043b\u044f \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0442\u044c <code>order</code> <code>str</code> <code>\"id\"</code> \u041f\u043e\u043b\u0435 \u0441\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u043a\u0438 <code>sort</code> <code>str</code> <code>\"asc\"</code> \u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435: <code>\"asc\"</code> / <code>\"desc\"</code> <code>limit</code> <code>int</code> <code>None</code> \u041c\u0430\u043a\u0441\u0438\u043c\u0443\u043c \u0437\u0430\u043f\u0438\u0441\u0435\u0439 <code>offset</code> <code>int</code> <code>0</code> \u041f\u0440\u043e\u043f\u0443\u0441\u0442\u0438\u0442\u044c N \u0437\u0430\u043f\u0438\u0441\u0435\u0439"},{"location":"backend/dotorm/queries/#_3","title":"\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440\u044b \u0444\u0438\u043b\u044c\u0442\u0440\u0430\u0446\u0438\u0438","text":"<pre><code># \u0420\u0430\u0432\u0435\u043d\u0441\u0442\u0432\u043e\n(\"status\", \"=\", \"active\")\n(\"status\", \"!=\", \"archived\")\n\n# \u0421\u0440\u0430\u0432\u043d\u0435\u043d\u0438\u0435\n(\"price\", \"&gt;\", 100)\n(\"price\", \"&gt;=\", 100)\n(\"price\", \"&lt;\", 1000)\n(\"price\", \"&lt;=\", 1000)\n\n# \u0412\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0435\n(\"chat_type\", \"in\", [\"group\", \"channel\"])\n(\"id\", \"not in\", [1, 2, 3])\n\n# \u0422\u0435\u043a\u0441\u0442\u043e\u0432\u044b\u0439 \u043f\u043e\u0438\u0441\u043a\n(\"name\", \"like\", \"%john%\")\n(\"name\", \"ilike\", \"%john%\")    # case-insensitive\n\n# NULL\n(\"deleted_at\", \"=\", None)\n(\"deleted_at\", \"!=\", None)\n</code></pre>"},{"location":"backend/dotorm/queries/#_4","title":"\u0421\u043e\u0441\u0442\u0430\u0432\u043d\u044b\u0435 \u0444\u0438\u043b\u044c\u0442\u0440\u044b","text":"<p>\u0412\u0441\u0435 \u0443\u0441\u043b\u043e\u0432\u0438\u044f \u0432 <code>filter</code> \u043e\u0431\u044a\u0435\u0434\u0438\u043d\u044f\u044e\u0442\u0441\u044f \u0447\u0435\u0440\u0435\u0437 <code>AND</code>:</p> <pre><code># WHERE is_active = true AND chat_type = 'group' AND name ILIKE '%test%'\nawait Chat.search(\n    filter=[\n        (\"is_active\", \"=\", True),\n        (\"chat_type\", \"=\", \"group\"),\n        (\"name\", \"ilike\", \"%test%\"),\n    ],\n)\n</code></pre>"},{"location":"backend/dotorm/queries/#get-id","title":"get \u2014 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043f\u043e ID","text":"<pre><code># \u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0432\u0441\u0435 \u043f\u043e\u043b\u044f\nchat = await Chat.get(1)\n\n# \u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0435 \u043f\u043e\u043b\u044f\nchat = await Chat.get(1, fields=[\"name\", \"is_archived\"])\n</code></pre> <p>get \u0431\u0440\u043e\u0441\u0430\u0435\u0442 \u0438\u0441\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435</p> <p>\u0415\u0441\u043b\u0438 \u0437\u0430\u043f\u0438\u0441\u044c \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u0430, <code>get()</code> \u0431\u0440\u043e\u0441\u0438\u0442 \u0438\u0441\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435. \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 <code>get_or_none()</code> \u0435\u0441\u043b\u0438 \u0437\u0430\u043f\u0438\u0441\u044c \u043c\u043e\u0436\u0435\u0442 \u043d\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043e\u0432\u0430\u0442\u044c.</p>"},{"location":"backend/dotorm/queries/#get_or_none","title":"get_or_none \u2014 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0435 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435","text":"<pre><code>chat = await Chat.get_or_none(999)\nif chat is None:\n    print(\"Chat not found\")\n</code></pre>"},{"location":"backend/dotorm/queries/#create","title":"create \u2014 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438","text":"<pre><code>chat_id = await Chat.create(\n    Chat(\n        name=\"Development\",\n        chat_type=\"group\",\n        creator_id=1,\n    )\n)\n# chat_id: int \u2014 ID \u0441\u043e\u0437\u0434\u0430\u043d\u043d\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438\n</code></pre>"},{"location":"backend/dotorm/queries/#bulk-create","title":"Bulk create","text":"<pre><code>ids = await ChatMessage.create_bulk([\n    ChatMessage(chat_id=1, body=\"Hello\", author_user_id=1),\n    ChatMessage(chat_id=1, body=\"World\", author_user_id=2),\n])\n# ids: list[int]\n</code></pre>"},{"location":"backend/dotorm/queries/#update","title":"update \u2014 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438","text":"<pre><code># \u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u2192 \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c\nchat = await Chat.get(1)\nawait chat.update(Chat(name=\"New Name\", is_archived=True))\n</code></pre> <p>\u041e\u0431\u043d\u043e\u0432\u043b\u044f\u044e\u0442\u0441\u044f \u0442\u043e\u043b\u044c\u043a\u043e \u0437\u0430\u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u043e\u043b\u044f. \u041f\u043e\u043b\u044f, \u043e\u0441\u0442\u0430\u0432\u043b\u0435\u043d\u043d\u044b\u0435 \u043a\u0430\u043a <code>Field</code> (\u043d\u0435 \u0437\u0430\u0434\u0430\u043d\u043d\u044b\u0435), \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u044e\u0442\u0441\u044f:</p> <pre><code># \u041e\u0431\u043d\u043e\u0432\u0438\u0442 \u0422\u041e\u041b\u042c\u041a\u041e name, \u043e\u0441\u0442\u0430\u043b\u044c\u043d\u044b\u0435 \u043f\u043e\u043b\u044f \u043d\u0435 \u0442\u0440\u043e\u043d\u0443\u0442\u044b\nawait chat.update(Chat(name=\"New Name\"))\n</code></pre>"},{"location":"backend/dotorm/queries/#_5","title":"\u0423\u043a\u0430\u0437\u0430\u043d\u0438\u0435 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0445 \u043f\u043e\u043b\u0435\u0439","text":"<pre><code>await chat.update(\n    Chat(name=\"New\", is_archived=True),\n    fields=[\"name\"],  # \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e name, is_archived \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f\n)\n</code></pre>"},{"location":"backend/dotorm/queries/#bulk-update","title":"Bulk update","text":"<pre><code>await Chat.update_bulk(\n    filter=[(\"is_archived\", \"=\", False)],\n    values={\"is_archived\": True},\n)\n</code></pre>"},{"location":"backend/dotorm/queries/#delete","title":"delete \u2014 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438","text":"<pre><code>chat = await Chat.get(1)\nawait chat.delete()\n</code></pre>"},{"location":"backend/dotorm/queries/#bulk-delete","title":"Bulk delete","text":"<pre><code>await Chat.delete_bulk([1, 2, 3])\n</code></pre>"},{"location":"backend/dotorm/queries/#table_len","title":"table_len \u2014 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0437\u0430\u043f\u0438\u0441\u0435\u0439","text":"<pre><code>count = await Chat.table_len()\n# count: int\n</code></pre>"},{"location":"backend/dotorm/queries/#_6","title":"\u041f\u0440\u0438\u043c\u0435\u0440\u044b \u0438\u0437 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u043e\u0434\u0430","text":""},{"location":"backend/dotorm/queries/#_7","title":"\u041f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0447\u0430\u0442\u0430","text":"<pre><code>async def get_messages(chat_id: int, before_id: int = None, limit: int = 50):\n    filter_conditions = [\n        (\"chat_id\", \"=\", chat_id),\n        (\"is_deleted\", \"=\", False),\n    ]\n\n    if before_id:\n        filter_conditions.append((\"id\", \"&lt;\", before_id))\n\n    return await env.models.chat_message.search(\n        filter=filter_conditions,\n        fields=[\"id\", \"body\", \"author_user_id\", \"created_at\", \"pinned\"],\n        order=\"id\",\n        sort=\"desc\",\n        limit=limit,\n    )\n</code></pre>"},{"location":"backend/dotorm/queries/#_8","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u0440\u0430\u0432 \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430 \u0447\u0430\u0442\u0430","text":"<pre><code>async def check_membership(chat_id: int, user_id: int):\n    members = await env.models.chat_member.search(\n        filter=[\n            (\"chat_id\", \"=\", chat_id),\n            (\"user_id\", \"=\", user_id),\n            (\"is_active\", \"=\", True),\n        ],\n        fields=[\"id\", \"is_admin\", \"can_write\", \"can_pin\"],\n        limit=1,\n    )\n    return members[0] if members else None\n</code></pre>"},{"location":"backend/dotorm/relations/","title":"\u0421\u0432\u044f\u0437\u0438 (Relations)","text":""},{"location":"backend/dotorm/relations/#_1","title":"\u0427\u0442\u0435\u043d\u0438\u0435 \u0441\u0432\u044f\u0437\u0435\u0439","text":""},{"location":"backend/dotorm/relations/#many2one","title":"Many2one \u2014 \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435","text":"<p>\u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e FK-\u043f\u043e\u043b\u044f \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u044e\u0442 \u0442\u043e\u043b\u044c\u043a\u043e ID. \u0414\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u044b\u0445 \u0434\u0430\u043d\u043d\u044b\u0445 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 <code>fields_nested</code>:</p> <pre><code># \u0422\u043e\u043b\u044c\u043a\u043e ID \u0430\u0432\u0442\u043e\u0440\u0430\nmsg = await ChatMessage.get(1, fields=[\"id\", \"body\", \"author_user_id\"])\nmsg.author_user_id  # 42 (int)\n\n# \u0421 \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u044b\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u043c\u0438 \u0430\u0432\u0442\u043e\u0440\u0430\nmsg = await ChatMessage.get(\n    1,\n    fields=[\"id\", \"body\", \"author_user_id\"],\n    fields_nested={\n        \"author_user_id\": [\"id\", \"name\", \"login\"],  # (1)!\n    },\n)\nmsg.author_user_id.id    # 42\nmsg.author_user_id.name  # \"John\"\n</code></pre> <ol> <li>\u041a\u043b\u044e\u0447 \u2014 \u0438\u043c\u044f FK-\u043f\u043e\u043b\u044f, \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u2014 \u0441\u043f\u0438\u0441\u043e\u043a \u043f\u043e\u043b\u0435\u0439 \u0438\u0437 \u0441\u0432\u044f\u0437\u0430\u043d\u043d\u043e\u0439 \u0442\u0430\u0431\u043b\u0438\u0446\u044b.</li> </ol>"},{"location":"backend/dotorm/relations/#one2many","title":"One2many \u2014 \u0434\u043e\u0447\u0435\u0440\u043d\u0438\u0435 \u0437\u0430\u043f\u0438\u0441\u0438","text":"<pre><code>chat = await Chat.get(\n    1,\n    fields=[\"id\", \"name\", \"messages\"],\n    fields_nested={\n        \"messages\": [\"id\", \"body\", \"author_user_id\"],\n    },\n)\n\nfor msg in chat.messages:\n    print(f\"{msg.author_user_id}: {msg.body}\")\n</code></pre>"},{"location":"backend/dotorm/relations/#many2many","title":"Many2many","text":"<pre><code>user = await User.get(\n    1,\n    fields=[\"id\", \"name\", \"role_ids\"],\n    fields_nested={\n        \"role_ids\": [\"id\", \"name\"],\n    },\n)\n\nfor role in user.role_ids:\n    print(role.name)  # \"admin\", \"manager\", ...\n</code></pre>"},{"location":"backend/dotorm/relations/#_2","title":"\u0417\u0430\u043f\u0438\u0441\u044c \u0441\u0432\u044f\u0437\u0435\u0439","text":""},{"location":"backend/dotorm/relations/#many2one-fk","title":"Many2one \u2014 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 FK","text":"<pre><code># \u041f\u0440\u0438 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0438\nmsg_id = await ChatMessage.create(\n    ChatMessage(chat_id=1, author_user_id=42, body=\"Hello\")\n)\n\n# \u041f\u0440\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0438\nawait msg.update(ChatMessage(author_user_id=99))\n</code></pre>"},{"location":"backend/dotorm/relations/#one2many-many2many","title":"One2many / Many2many \u2014 \u043a\u043e\u043c\u0430\u043d\u0434\u044b","text":"<p>\u0414\u043b\u044f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f One2many \u0438 Many2many \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u044e\u0442\u0441\u044f \u043a\u043e\u043c\u0430\u043d\u0434\u044b:</p> <pre><code>await user.update(User(\n    role_ids={\n        \"selected\": [1, 2, 3],       # \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0432\u044f\u0437\u0438 (\u0437\u0430\u043c\u0435\u043d\u0438\u0442\u044c)\n        \"created\": [                   # \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0435 \u0437\u0430\u043f\u0438\u0441\u0438\n            {\"name\": \"New Role\"},\n        ],\n        \"deleted\": [4, 5],            # \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0441\u0432\u044f\u0437\u0438\n    }\n))\n</code></pre> \u041a\u043e\u043c\u0430\u043d\u0434\u0430 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>selected</code> \u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0432\u044f\u0437\u0438 \u0441 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u043c\u0438 \u0437\u0430\u043f\u0438\u0441\u044f\u043c\u0438 <code>unselected</code> \u0423\u0431\u0440\u0430\u0442\u044c \u0441\u0432\u044f\u0437\u0438 (\u0431\u0435\u0437 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u044f \u0437\u0430\u043f\u0438\u0441\u0435\u0439) <code>created</code> \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0435 \u0437\u0430\u043f\u0438\u0441\u0438 \u0438 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0432\u044f\u0437\u0438 <code>deleted</code> \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0437\u0430\u043f\u0438\u0441\u0438 \u043f\u043e ID <pre><code># \u041f\u0440\u0438\u043c\u0435\u0440: \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430 \u0432 \u0447\u0430\u0442\nawait chat.update(Chat(\n    members={\n        \"created\": [\n            {\n                \"user_id\": new_user_id,\n                \"is_active\": True,\n                \"can_read\": True,\n                \"can_write\": True,\n            }\n        ],\n    }\n))\n\n# \u041f\u0440\u0438\u043c\u0435\u0440: \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430 \u0438\u0437 \u0447\u0430\u0442\u0430\nawait chat.update(Chat(\n    members={\n        \"deleted\": [member_id],\n    }\n))\n</code></pre>"},{"location":"backend/dotorm/relations/#chat","title":"\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430 \u0441\u0432\u044f\u0437\u0435\u0439 (Chat \u043c\u043e\u0434\u0443\u043b\u044c)","text":"<pre><code>erDiagram\n    chats ||--o{ chat_messages : \"has many\"\n    chats ||--o{ chat_members : \"has many\"\n    users ||--o{ chat_messages : \"author\"\n    users ||--o{ chat_members : \"member\"\n    chat_messages ||--o| chat_messages : \"reply_to\"\n\n    chats {\n        int id PK\n        varchar name\n        varchar chat_type\n        int creator_id FK\n        boolean is_archived\n    }\n\n    chat_messages {\n        int id PK\n        int chat_id FK\n        int author_user_id FK\n        text body\n        boolean pinned\n        boolean is_deleted\n        int reply_to_id FK\n    }\n\n    chat_members {\n        int id PK\n        int chat_id FK\n        int user_id FK\n        boolean is_active\n        boolean is_admin\n        boolean can_write\n        boolean can_pin\n    }</code></pre>"},{"location":"backend/modules/chat/","title":"Chat Module","text":"<p>Real-time \u0447\u0430\u0442 \u0441 WebSocket, PubSub \u0438 \u0438\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0435\u0439 \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c\u0438 \u043c\u0435\u0441\u0441\u0435\u043d\u0434\u0436\u0435\u0440\u0430\u043c\u0438.</p>"},{"location":"backend/modules/chat/#_1","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430","text":"<pre><code>graph TB\n    subgraph Clients\n        B1[Browser 1]\n        B2[Browser 2]\n    end\n\n    subgraph \"FastAPI Worker 1\"\n        WS1[WebSocket Handler]\n        CM1[ConnectionManager]\n    end\n\n    subgraph \"FastAPI Worker 2\"\n        WS2[WebSocket Handler]\n        CM2[ConnectionManager]\n    end\n\n    B1 &lt;--&gt;|WebSocket| WS1\n    B2 &lt;--&gt;|WebSocket| WS2\n    CM1 &lt;--&gt;|PubSub| PG[(PostgreSQL&lt;br&gt;LISTEN/NOTIFY)]\n    CM2 &lt;--&gt;|PubSub| PG\n\n    style PG fill:#336791,color:white</code></pre> <p>Cross-process messaging</p> <p>\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u043f\u0440\u043e\u0445\u043e\u0434\u044f\u0442 \u0447\u0435\u0440\u0435\u0437 PostgreSQL <code>LISTEN/NOTIFY</code> (\u0438\u043b\u0438 Redis Pub/Sub) \u2014 \u044d\u0442\u043e \u0433\u0430\u0440\u0430\u043d\u0442\u0438\u0440\u0443\u0435\u0442 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0443 \u043c\u0435\u0436\u0434\u0443 \u0432\u0441\u0435\u043c\u0438 worker-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u0430\u043c\u0438.</p>"},{"location":"backend/modules/chat/#_2","title":"\u0422\u0438\u043f\u044b \u0447\u0430\u0442\u043e\u0432","text":"\u0422\u0438\u043f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041f\u0440\u0430\u0432\u0430 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e <code>direct</code> \u041b\u0438\u0447\u043d\u044b\u0439 \u0447\u0430\u0442 1-\u043d\u0430-1 \u0427\u0442\u0435\u043d\u0438\u0435, \u0437\u0430\u043f\u0438\u0441\u044c, pin <code>group</code> \u0413\u0440\u0443\u043f\u043f\u043e\u0432\u043e\u0439 \u0447\u0430\u0442 \u0427\u0442\u0435\u043d\u0438\u0435, \u0437\u0430\u043f\u0438\u0441\u044c <code>channel</code> \u041a\u0430\u043d\u0430\u043b (\u0442\u043e\u043b\u044c\u043a\u043e \u0430\u0434\u043c\u0438\u043d\u044b \u043f\u0438\u0448\u0443\u0442) \u0422\u043e\u043b\u044c\u043a\u043e \u0447\u0442\u0435\u043d\u0438\u0435 <code>record</code> \u0427\u0430\u0442 \u043f\u0440\u0438\u0432\u044f\u0437\u0430\u043d\u043d\u044b\u0439 \u043a \u0437\u0430\u043f\u0438\u0441\u0438 CRM \u0427\u0442\u0435\u043d\u0438\u0435, \u0437\u0430\u043f\u0438\u0441\u044c"},{"location":"backend/modules/chat/#api-messages","title":"API \u2014 Messages","text":""},{"location":"backend/modules/chat/#_3","title":"\u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f","text":"<p>POST <code>/chats/{chat_id}/messages</code></p> <pre><code>{\n    \"body\": \"Hello, World!\",\n    \"attachments\": [],\n    \"reply_to_id\": null\n}\n</code></pre>"},{"location":"backend/modules/chat/#_4","title":"\u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439","text":"<p>GET <code>/chats/{chat_id}/messages?limit=50&amp;before_id=100</code></p> <p>\u041f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044f \u043a\u0443\u0440\u0441\u043e\u0440\u043e\u043c: <code>before_id</code> \u2014 \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0441\u0442\u0430\u0440\u0448\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e ID.</p>"},{"location":"backend/modules/chat/#_5","title":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435","text":"<p>PATCH <code>/chats/{chat_id}/messages/{message_id}</code></p> <pre><code>{\n    \"body\": \"Edited message text\"\n}\n</code></pre>"},{"location":"backend/modules/chat/#_6","title":"\u0423\u0434\u0430\u043b\u0435\u043d\u0438\u0435","text":"<p>DELETE <code>/chats/{chat_id}/messages/{message_id}</code></p> <p>Soft delete \u2014 <code>is_deleted = true</code>.</p>"},{"location":"backend/modules/chat/#pin-unpin","title":"Pin / Unpin","text":"<p>POST <code>/chats/{chat_id}/messages/{message_id}/pin</code></p> <pre><code>{\"pinned\": true}\n</code></pre>"},{"location":"backend/modules/chat/#_7","title":"\u0420\u0435\u0430\u043a\u0446\u0438\u0438","text":"<p>POST <code>/chats/{chat_id}/messages/{message_id}/reactions</code></p> <pre><code>{\"emoji\": \"\ud83d\udc4d\"}\n</code></pre> <p>\u041f\u043e\u0432\u0442\u043e\u0440\u043d\u044b\u0439 \u0432\u044b\u0437\u043e\u0432 \u0441 \u0442\u0435\u043c \u0436\u0435 emoji \u2014 toggle (\u0443\u0431\u0438\u0440\u0430\u0435\u0442 \u0440\u0435\u0430\u043a\u0446\u0438\u044e).</p>"},{"location":"backend/modules/chat/#websocket-events","title":"WebSocket Events","text":"<p>\u041a\u043b\u0438\u0435\u043d\u0442 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u0442\u0441\u044f \u043a <code>/ws</code> \u0438 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u0441\u043e\u0431\u044b\u0442\u0438\u044f:</p> <pre><code>// \u041f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435\nconst ws = new WebSocket(`wss://api.fara.dev/ws?token=${token}`);\n\nws.onmessage = (event) =&gt; {\n    const data = JSON.parse(event.data);\n\n    switch (data.type) {\n        case \"new_message\":\n            // \u041d\u043e\u0432\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n            addMessage(data.chat_id, data.message);\n            break;\n\n        case \"message_edited\":\n            updateMessage(data.message_id, data.body);\n            break;\n\n        case \"message_deleted\":\n            removeMessage(data.message_id);\n            break;\n\n        case \"message_pinned\":\n            togglePin(data.message_id, data.pinned);\n            break;\n\n        case \"reaction_update\":\n            updateReaction(data.message_id, data.reactions);\n            break;\n    }\n};\n</code></pre>"},{"location":"backend/modules/chat/#pubsub-strategy-pattern","title":"PubSub \u2014 Strategy Pattern","text":"<p>PubSub backend \u0432\u044b\u0431\u0438\u0440\u0430\u0435\u0442\u0441\u044f \u0447\u0435\u0440\u0435\u0437 <code>.env</code>:</p> PostgreSQL (\u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e)Redis .env<pre><code>PUBSUB__BACKEND=pg\n</code></pre> <p>\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 <code>LISTEN/NOTIFY</code>. \u041f\u0440\u043e\u0441\u0442\u043e, \u0431\u0435\u0437 \u0434\u043e\u043f. \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b.</p> .env<pre><code>PUBSUB__BACKEND=redis\nPUBSUB__REDIS_URL=redis://localhost:6379/0\n</code></pre> <p>\u0412\u044b\u0448\u0435 throughput, \u043d\u0435 \u0437\u0430\u043d\u0438\u043c\u0430\u0435\u0442 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0438\u0437 asyncpg pool.</p> <p>\u041f\u0435\u0440\u0435\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 backend'\u0430 \u043d\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043a\u043e\u0434\u0430 \u2014 Strategy pattern:</p> backend/base/crm/chat/websocket/pubsub/<pre><code># pubsub/\n# \u251c\u2500\u2500 __init__.py      # create_pubsub_backend() factory\n# \u251c\u2500\u2500 base.py          # PubSubBackend (abstract)\n# \u251c\u2500\u2500 pg_backend.py    # PostgreSQL LISTEN/NOTIFY\n# \u2514\u2500\u2500 redis_backend.py # Redis Pub/Sub\n</code></pre>"},{"location":"backend/modules/chat/#_8","title":"\u041c\u043e\u0434\u0435\u043b\u0438","text":""},{"location":"backend/modules/chat/#chat","title":"Chat","text":"<pre><code>class Chat(DotModel):\n    __table__ = \"chats\"\n\n    name: str = Char(max_length=255, required=True)\n    chat_type: str = Selection(\n        selection=[\n            (\"direct\", \"\u041b\u0438\u0447\u043d\u044b\u0439\"), (\"group\", \"\u0413\u0440\u0443\u043f\u043f\u0430\"),\n            (\"channel\", \"\u041a\u0430\u043d\u0430\u043b\"), (\"record\", \"\u0427\u0430\u0442 \u0437\u0430\u043f\u0438\u0441\u0438\"),\n        ],\n        default=\"group\",\n    )\n    creator_id: \"User\" = Many2one[\"User\"](relation_table=\"users\")\n    is_archived: bool = Boolean(default=False)\n</code></pre>"},{"location":"backend/modules/chat/#chatmember","title":"ChatMember","text":"<pre><code>class ChatMember(DotModel):\n    __table__ = \"chat_members\"\n\n    chat_id = Many2one[\"Chat\"](relation_table=\"chats\", required=True)\n    user_id = Many2one[\"User\"](relation_table=\"users\", required=True)\n    is_active = Boolean(default=True)\n    is_admin = Boolean(default=False)\n    can_read = Boolean(default=True)\n    can_write = Boolean(default=True)\n    can_pin = Boolean(default=False)\n    can_invite = Boolean(default=False)\n    can_delete_others = Boolean(default=False)\n</code></pre>"},{"location":"backend/modules/chat/#_9","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u0440\u0430\u0432","text":"<pre><code># Shortcut-\u043c\u0435\u0442\u043e\u0434\u044b \u043d\u0430 ChatMember\nawait ChatMember.check_can_write(chat_id, user_id)\nawait ChatMember.check_can_pin(chat_id, user_id)\nawait ChatMember.check_admin(chat_id, user_id)\n\n# \u041f\u043e\u0434 \u043a\u0430\u043f\u043e\u0442\u043e\u043c:\nmember = await ChatMember.check_membership(chat_id, user_id)  # \u0438\u043b\u0438 403\nif not member.has_permission(\"can_pin\"):\n    raise FaraException(\"PERMISSION_DENIED\")\n</code></pre>"},{"location":"backend/modules/security/","title":"Security Module","text":"<p>\u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f, \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u044f, ACL \u0438 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0441\u0435\u0441\u0441\u0438\u044f\u043c\u0438.</p>"},{"location":"backend/modules/security/#_1","title":"\u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f","text":"<p>Bearer-\u0442\u043e\u043a\u0435\u043d \u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0435 <code>Authorization</code>:</p> <pre><code>Authorization: Bearer &lt;token&gt;\n</code></pre>"},{"location":"backend/modules/security/#_2","title":"\u0426\u0435\u043f\u043e\u0447\u043a\u0430 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438","text":"<pre><code>sequenceDiagram\n    participant C as Client\n    participant MW as AuthToken Middleware\n    participant DB as PostgreSQL\n    participant CV as ContextVar\n\n    C-&gt;&gt;MW: Request + Bearer token\n    MW-&gt;&gt;DB: SELECT session + user WHERE token = ?\n    DB--&gt;&gt;MW: session_data\n    MW-&gt;&gt;MW: Check expired_datetime &gt; now()\n    MW-&gt;&gt;CV: set_access_session(session)\n    MW-&gt;&gt;MW: request.state.session = session\n    MW--&gt;&gt;C: Continue to router</code></pre>"},{"location":"backend/modules/security/#session","title":"Session","text":"<pre><code># \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0441\u0435\u0441\u0441\u0438\u0438 (\u043f\u0440\u0438 \u043b\u043e\u0433\u0438\u043d\u0435)\nsession = Session(\n    user_id=user_id,\n    token=secrets.token_urlsafe(64),\n    ttl=3600,\n    expired_datetime=datetime.now(tz=utc) + timedelta(hours=1),\n    active=True,\n)\nawait Session.create(session)\n</code></pre>"},{"location":"backend/modules/security/#_3","title":"\u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0441\u0435\u0441\u0441\u0438\u0438 \u0432 \u0440\u043e\u0443\u0442\u0435\u0440\u0435","text":"<pre><code>@router.get(\"/me\")\nasync def get_current_user(req: Request):\n    session = req.state.session        # \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d middleware\n    user_id = session.user_id.id       # session.user_id \u2014 \u043e\u0431\u044a\u0435\u043a\u0442 User\n    is_admin = session.user_id.is_admin\n\n    return {\"user_id\": user_id, \"is_admin\": is_admin}\n</code></pre>"},{"location":"backend/modules/security/#access-control-acl","title":"Access Control (ACL)","text":"<p>DotORM \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 \u0432\u0441\u0442\u0440\u043e\u0435\u043d\u043d\u0443\u044e \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0443 \u043f\u0440\u0430\u0432 \u043d\u0430 \u0443\u0440\u043e\u0432\u043d\u0435 ORM \u0447\u0435\u0440\u0435\u0437 <code>ContextVar</code>:</p> <pre><code>from backend.base.system.dotorm.dotorm.access import (\n    set_access_session,\n    get_access_session,\n)\n\n# \u0423\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f middleware \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\nset_access_session(session)\n\n# ORM \u043f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u0442 \u043f\u0440\u0438 \u043a\u0430\u0436\u0434\u043e\u0439 \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u0438:\nawait record.update(...)   # \u2192 _check_access(Operation.UPDATE)\nawait Model.create(...)    # \u2192 _check_access(Operation.CREATE)\nawait Model.search(...)    # \u2192 _check_access(Operation.READ) + domain filter\n</code></pre>"},{"location":"backend/modules/security/#_4","title":"\u0423\u0440\u043e\u0432\u043d\u0438 \u0434\u043e\u0441\u0442\u0443\u043f\u0430","text":"<ol> <li>Table ACL \u2014 \u043c\u043e\u0436\u0435\u0442 \u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0432\u043e\u043e\u0431\u0449\u0435 \u0447\u0438\u0442\u0430\u0442\u044c/\u043f\u0438\u0441\u0430\u0442\u044c \u0442\u0430\u0431\u043b\u0438\u0446\u0443</li> <li>Row Rules \u2014 \u0432\u0438\u0434\u0438\u0442 \u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0435 \u0437\u0430\u043f\u0438\u0441\u0438 (domain filter)</li> </ol> <pre><code>class Product(DotModel):\n    __table__ = \"products\"\n    __access__ = {\n        \"read\": True,        # \u0432\u0441\u0435 \u043c\u043e\u0433\u0443\u0442 \u0447\u0438\u0442\u0430\u0442\u044c\n        \"create\": \"admin\",   # \u0442\u043e\u043b\u044c\u043a\u043e \u0430\u0434\u043c\u0438\u043d\u044b \u0441\u043e\u0437\u0434\u0430\u044e\u0442\n        \"update\": \"admin\",\n        \"delete\": \"admin\",\n    }\n</code></pre>"},{"location":"backend/modules/security/#systemsession","title":"SystemSession","text":"<p>\u0414\u043b\u044f \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u0439 \u043e\u0442 \u0438\u043c\u0435\u043d\u0438 \u0441\u0438\u0441\u0442\u0435\u043c\u044b (cron, post_init) \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f <code>SystemSession</code>:</p> <pre><code>from backend.base.crm.security.models.sessions import SystemSession\nfrom backend.base.system.dotorm.dotorm.access import set_access_session\n\n# \u0414\u0430\u0451\u0442 \u043f\u043e\u043b\u043d\u044b\u0439 \u0434\u043e\u0441\u0442\u0443\u043f \u043a\u043e \u0432\u0441\u0435\u043c \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u044f\u043c\nset_access_session(SystemSession(user_id=SYSTEM_USER_ID))\n</code></pre> <p>\u0422\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u0441\u0435\u0440\u0432\u0435\u0440\u043d\u043e\u0433\u043e \u043a\u043e\u0434\u0430</p> <p><code>SystemSession</code> \u043e\u0431\u0445\u043e\u0434\u0438\u0442 \u0432\u0441\u0435 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0438 \u0434\u043e\u0441\u0442\u0443\u043f\u0430. \u041d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0439 \u0435\u0433\u043e \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u0441\u043a\u0438\u0445 \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432.</p>"},{"location":"backend/testing/","title":"\u0422\u0435\u0441\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435","text":""},{"location":"backend/testing/#_2","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u0442\u0435\u0441\u0442\u043e\u0432","text":"<pre><code>tests/\n\u251c\u2500\u2500 conftest.py              # Fixtures: DB pool, env, client\n\u251c\u2500\u2500 integration/\n\u2502   \u251c\u2500\u2500 messages/\n\u2502   \u2502   \u2514\u2500\u2500 test_messages_api.py\n\u2502   \u251c\u2500\u2500 chats/\n\u2502   \u2514\u2500\u2500 security/\n\u2514\u2500\u2500 performance/\n    \u251c\u2500\u2500 conftest.py\n    \u2514\u2500\u2500 test_orm_performance.py\n</code></pre>"},{"location":"backend/testing/#_3","title":"\u0417\u0430\u043f\u0443\u0441\u043a","text":"<pre><code># \u0412\u0441\u0435 \u0442\u0435\u0441\u0442\u044b\npytest tests/ -v\n\n# \u0422\u043e\u043b\u044c\u043a\u043e integration\npytest tests/integration/ -v -m integration\n\n# \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0442\u0435\u0441\u0442\npytest tests/integration/messages/test_messages_api.py::TestPinMessageAPI -v\n\n# \u0421 coverage\npytest tests/ --cov=backend --cov-report=html\n</code></pre>"},{"location":"backend/testing/#fixtures","title":"\u041a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 fixtures","text":""},{"location":"backend/testing/#db_pool-asyncpg","title":"<code>db_pool</code> \u2014 asyncpg \u043f\u0443\u043b","text":"<p>Session-scoped. \u0421\u043e\u0437\u0434\u0430\u0451\u0442 \u043f\u0443\u043b, DDL-\u0442\u0430\u0431\u043b\u0438\u0446\u044b, \u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 <code>SystemSession</code>:</p> <pre><code>@pytest_asyncio.fixture(scope=\"session\", autouse=True)\nasync def db_pool():\n    pool = await asyncpg.create_pool(\n        dsn=TEST_DATABASE_URL,\n        min_size=5,\n        max_size=10,\n    )\n    set_access_session(SystemSession(user_id=SYSTEM_USER_ID))\n    await _create_all_tables(pool)\n\n    yield pool\n\n    await pool.close()\n</code></pre>"},{"location":"backend/testing/#clean_all_tables","title":"<code>clean_all_tables</code> \u2014 \u043e\u0447\u0438\u0441\u0442\u043a\u0430 \u043c\u0435\u0436\u0434\u0443 \u0442\u0435\u0441\u0442\u0430\u043c\u0438","text":"<p>Autouse. <code>TRUNCATE ... CASCADE</code> \u0432\u0441\u0435\u0445 \u0442\u0430\u0431\u043b\u0438\u0446 \u043f\u0435\u0440\u0435\u0434 \u043a\u0430\u0436\u0434\u044b\u043c \u0442\u0435\u0441\u0442\u043e\u043c:</p> <pre><code>@pytest_asyncio.fixture(autouse=True)\nasync def clean_all_tables(db_pool):\n    tables = [m.__table__ for m in models._get_models()]\n    async with db_pool.acquire() as conn:\n        await conn.execute(f\"TRUNCATE TABLE {', '.join(tables)} CASCADE\")\n</code></pre>"},{"location":"backend/testing/#app-fastapi","title":"<code>app</code> \u2014 FastAPI \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435","text":"<pre><code>@pytest_asyncio.fixture\nasync def app(test_env):\n    app = FastAPI()\n    app.state.env = test_env\n\n    await test_env.setup_services()\n    await test_env.start_services_before(app)\n    await test_env.load_routers(app)\n    await test_env.start_services_after(app)\n    test_env.add_handlers_errors(app)\n\n    yield app\n\n    await test_env.stop_services(app)  # (1)!\n</code></pre> <ol> <li> \u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0432\u044b\u0437\u044b\u0432\u0430\u0439 <code>stop_services()</code> \u2014 \u0438\u043d\u0430\u0447\u0435 PubSub LISTEN-\u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0443\u0442\u0435\u0447\u0451\u0442 \u0438\u0437 \u043f\u0443\u043b\u0430, \u0438 \u0442\u0435\u0441\u0442\u044b \u043d\u0430\u0447\u043d\u0443\u0442 \u0437\u0430\u0432\u0438\u0441\u0430\u0442\u044c.</li> </ol>"},{"location":"backend/testing/#authenticated_client-http-","title":"<code>authenticated_client</code> \u2014 HTTP-\u043a\u043b\u0438\u0435\u043d\u0442 \u0441 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0435\u0439","text":"<pre><code>@pytest_asyncio.fixture\nasync def authenticated_client(client, test_env):\n    # \u0421\u043e\u0437\u0434\u0430\u0451\u0442 user + session + token\n    user_id = await User.create(User(name=\"Test\", login=\"test\", ...))\n    token = secrets.token_urlsafe(64)\n    await Session.create(Session(user_id=user_id, token=token, ...))\n\n    client.headers[\"Authorization\"] = f\"Bearer {token}\"\n    yield client, user_id, token\n</code></pre>"},{"location":"backend/testing/#_4","title":"\u041d\u0430\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0442\u0435\u0441\u0442\u043e\u0432","text":"<p>\u041f\u043e\u0434\u0440\u043e\u0431\u043d\u0435\u0435: Integration Tests</p>"},{"location":"backend/testing/integration/","title":"Integration Tests","text":""},{"location":"backend/testing/integration/#_1","title":"\u041f\u0430\u0442\u0442\u0435\u0440\u043d","text":"<p>\u041a\u0430\u0436\u0434\u044b\u0439 \u0442\u0435\u0441\u0442-\u043a\u043b\u0430\u0441\u0441:</p> <ol> <li><code>_setup()</code> \u2014 \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u0434\u0430\u043d\u043d\u044b\u0435 (chat, member, messages)</li> <li><code>@patch</code> \u2014 \u043c\u043e\u043a\u0430\u0435\u0442 WebSocket</li> <li>\u0414\u0435\u043b\u0430\u0435\u0442 HTTP-\u0437\u0430\u043f\u0440\u043e\u0441 \u0447\u0435\u0440\u0435\u0437 <code>authenticated_client</code></li> <li>\u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u0442 \u043e\u0442\u0432\u0435\u0442 \u0438 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u0411\u0414</li> </ol> <pre><code>class TestPinMessageAPI:\n\n    async def _setup(self, authenticated_client):\n        \"\"\"\u0421\u043e\u0437\u0434\u0430\u0442\u044c \u0447\u0430\u0442, \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430 \u0438 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435.\"\"\"\n        client, user_id, token = authenticated_client\n\n        from backend.base.crm.chat.models.chat import Chat\n        from backend.base.crm.chat.models.chat_message import ChatMessage\n        from backend.base.crm.chat.models.chat_member import ChatMember\n\n        chat_id = await Chat.create(Chat(name=\"Test Chat\"))\n        await ChatMember.create(\n            ChatMember(\n                chat_id=chat_id,\n                user_id=user_id,\n                is_active=True,\n                can_pin=True,           # (1)!\n            )\n        )\n        msg_id = await ChatMessage.create(\n            ChatMessage(\n                chat_id=chat_id,\n                body=\"Pin this\",\n                author_user_id=user_id,\n            )\n        )\n        return client, chat_id, msg_id\n\n    @patch(\n        \"backend.base.crm.chat.websocket.chat_manager.send_to_chat\",\n        new_callable=AsyncMock,\n    )\n    async def test_pin_message(self, mock_ws, authenticated_client):\n        client, chat_id, msg_id = await self._setup(authenticated_client)\n\n        response = await client.post(\n            f\"/chats/{chat_id}/messages/{msg_id}/pin\",\n            json={\"pinned\": True},\n        )\n\n        assert response.status_code == 200\n        assert response.json()[\"pinned\"] is True\n        mock_ws.assert_called_once()        # (2)!\n</code></pre> <ol> <li>\u041d\u0435 \u0437\u0430\u0431\u0443\u0434\u044c \u0432\u044b\u0434\u0430\u0442\u044c \u043d\u0443\u0436\u043d\u044b\u0435 \u043f\u0440\u0430\u0432\u0430 \u0442\u0435\u0441\u0442\u043e\u0432\u043e\u043c\u0443 \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0443.</li> <li>\u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0439, \u0447\u0442\u043e WebSocket-\u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435 \u0431\u044b\u043b\u043e \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043e.</li> </ol>"},{"location":"backend/testing/integration/#websocket","title":"\u041c\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 WebSocket","text":"<p><code>chat_manager.send_to_chat</code> \u2014 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u043e\u0431\u044b\u0442\u0438\u044f \u0447\u0435\u0440\u0435\u0437 PubSub (PG LISTEN/NOTIFY \u0438\u043b\u0438 Redis). \u0412 \u0442\u0435\u0441\u0442\u0430\u0445 \u043c\u043e\u043a\u0430\u0435\u043c \u0447\u0442\u043e\u0431\u044b \u043d\u0435 \u0437\u0430\u0432\u0438\u0441\u0435\u0442\u044c \u043e\u0442 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u0439 \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b:</p> <pre><code>from unittest.mock import AsyncMock, patch\n\n@patch(\n    \"backend.base.crm.chat.websocket.chat_manager.send_to_chat\",\n    new_callable=AsyncMock,\n)\nasync def test_send_message(self, mock_ws, authenticated_client):\n    # mock_ws \u2014 AsyncMock, \u043f\u0435\u0440\u0435\u0445\u0432\u0430\u0442\u044b\u0432\u0430\u0435\u0442 \u0432\u044b\u0437\u043e\u0432\u044b send_to_chat\n    ...\n\n    # \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0447\u0442\u043e WS-\u0441\u043e\u0431\u044b\u0442\u0438\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043e \u0441 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u044b\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u043c\u0438\n    mock_ws.assert_called_once_with(\n        chat_id=chat_id,\n        message={\n            \"type\": \"new_message\",\n            \"chat_id\": chat_id,\n            ...\n        },\n    )\n</code></pre> <p>\u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u043e\u0432 \u0441 @patch</p> <p>\u041f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 <code>@patch</code> \u043a\u0430\u043a \u0434\u0435\u043a\u043e\u0440\u0430\u0442\u043e\u0440\u0430, mock \u043f\u0435\u0440\u0435\u0434\u0430\u0451\u0442\u0441\u044f \u043f\u0435\u0440\u0432\u044b\u043c \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u043e\u043c \u043f\u043e\u0441\u043b\u0435 <code>self</code>:</p> <pre><code># \u2705 \u041f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e: mock_ws \u043f\u0435\u0440\u0435\u0434 fixture\nasync def test_foo(self, mock_ws, authenticated_client):\n\n# \u274c \u041d\u0435\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e: mock_ws \u043f\u043e\u0441\u043b\u0435 fixture\nasync def test_foo(self, authenticated_client, mock_ws):\n</code></pre>"},{"location":"backend/testing/integration/#_2","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f \u0411\u0414","text":"<p>\u041f\u043e\u0441\u043b\u0435 HTTP-\u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043f\u0440\u043e\u0432\u0435\u0440\u044f\u0439 \u0447\u0442\u043e \u0434\u0430\u043d\u043d\u044b\u0435 \u0440\u0435\u0430\u043b\u044c\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u043b\u0438\u0441\u044c:</p> <pre><code>@patch(...)\nasync def test_edit_message(self, mock_ws, authenticated_client):\n    client, chat_id, msg_id, user_id = await self._setup(authenticated_client)\n\n    response = await client.patch(\n        f\"/chats/{chat_id}/messages/{msg_id}\",\n        json={\"body\": \"Edited text\"},\n    )\n\n    assert response.status_code == 200\n\n    # \u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c \u0411\u0414 \u043d\u0430\u043f\u0440\u044f\u043c\u0443\u044e\n    from backend.base.crm.chat.models.chat_message import ChatMessage\n    msg = await ChatMessage.get(msg_id)\n    assert msg.body == \"Edited text\"\n    assert msg.is_edited is True\n</code></pre>"},{"location":"backend/testing/integration/#_3","title":"\u0422\u0438\u043f\u0438\u0447\u043d\u044b\u0435 \u043e\u0448\u0438\u0431\u043a\u0438","text":""},{"location":"backend/testing/integration/#_4","title":"\u0422\u0435\u0441\u0442\u044b \u0437\u0430\u0432\u0438\u0441\u0430\u044e\u0442","text":"<p>\u041f\u0440\u0438\u0447\u0438\u043d\u0430: \u0443\u0442\u0435\u0447\u043a\u0430 PubSub LISTEN-\u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f \u0438\u0437 \u043f\u0443\u043b\u0430.</p> <p>\u0420\u0435\u0448\u0435\u043d\u0438\u0435: \u0443\u0431\u0435\u0434\u0438\u0441\u044c \u0447\u0442\u043e <code>app</code> fixture \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442 <code>stop_services()</code>:</p> <pre><code>@pytest_asyncio.fixture\nasync def app(test_env):\n    ...\n    yield app\n    await test_env.stop_services(app)  # \u2190 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\n</code></pre>"},{"location":"backend/testing/integration/#403","title":"403 \u0432 \u0442\u0435\u0441\u0442\u0430\u0445","text":"<p>\u041f\u0440\u0438\u0447\u0438\u043d\u0430: \u0442\u0435\u0441\u0442\u043e\u0432\u044b\u0439 <code>ChatMember</code> \u0441\u043e\u0437\u0434\u0430\u043d \u0431\u0435\u0437 \u043d\u0443\u0436\u043d\u044b\u0445 \u043f\u0440\u0430\u0432.</p> <p>\u0420\u0435\u0448\u0435\u043d\u0438\u0435: \u044f\u0432\u043d\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0439 \u043f\u0440\u0430\u0432\u0430:</p> <pre><code>await ChatMember.create(\n    ChatMember(\n        chat_id=chat_id,\n        user_id=user_id,\n        is_active=True,\n        can_write=True,    # \u0434\u043b\u044f \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439\n        can_pin=True,      # \u0434\u043b\u044f \u0437\u0430\u043a\u0440\u0435\u043f\u043b\u0435\u043d\u0438\u044f\n        is_admin=True,     # \u0434\u043b\u044f admin-\u043e\u043f\u0435\u0440\u0430\u0446\u0438\u0439\n    )\n)\n</code></pre>"},{"location":"frontend/","title":"Frontend","text":"<p>React SPA \u043d\u0430 TypeScript \u0441 Mantine UI, Redux Toolkit \u0438 \u043c\u043e\u0434\u0443\u043b\u044c\u043d\u043e\u0439 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043e\u0439.</p>"},{"location":"frontend/#_1","title":"\u0421\u0442\u0435\u043a","text":"\u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u0412\u0435\u0440\u0441\u0438\u044f \u041d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 React 18 UI framework TypeScript 5 \u0422\u0438\u043f\u0438\u0437\u0430\u0446\u0438\u044f Mantine 8 UI-\u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b Redux Toolkit \u2014 State management RTK Query \u2014 Data fetching + \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 Vite \u2014 \u0421\u0431\u043e\u0440\u043a\u0430 i18next \u2014 \u0418\u043d\u0442\u0435\u0440\u043d\u0430\u0446\u0438\u043e\u043d\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f (ru/en)"},{"location":"frontend/#_2","title":"\u0417\u0430\u043f\u0443\u0441\u043a","text":"<pre><code>cd frontend\nyarn install\nyarn dev\n# or npm\n# npm install\n# npm run dev       # http://localhost:5173\n# npm run build     # production build\n# npm run lint      # ESLint\n</code></pre>"},{"location":"frontend/#_3","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430","text":"<pre><code>frontend/src/\n\u251c\u2500\u2500 main.tsx                # Entry point\n\u251c\u2500\u2500 App.tsx                 # Root component + providers\n\u251c\u2500\u2500 config/                 # API URL, env config\n\u251c\u2500\u2500 store/                  # Redux store\n\u251c\u2500\u2500 slices/                 # Redux slices (auth, etc.)\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 api/                # RTK Query endpoints\n\u2502   \u2502   \u251c\u2500\u2500 crudApi.ts      # \u0423\u043d\u0438\u0432\u0435\u0440\u0441\u0430\u043b\u044c\u043d\u044b\u0439 CRUD API\n\u2502   \u2502   \u251c\u2500\u2500 chat.ts\n\u2502   \u2502   \u2514\u2500\u2500 users.ts\n\u2502   \u251c\u2500\u2500 auth/               # Auth service\n\u2502   \u2514\u2500\u2500 hooks/              # Custom hooks\n\u251c\u2500\u2500 route/                  # Routing\n\u251c\u2500\u2500 layout/                 # App layout\n\u251c\u2500\u2500 locales/                # i18n translations\n\u2502   \u251c\u2500\u2500 ru/\n\u2502   \u2514\u2500\u2500 en/\n\u251c\u2500\u2500 shared/                 # Shared utilities\n\u251c\u2500\u2500 types/                  # Global TypeScript types\n\u251c\u2500\u2500 assets/                 # Images, icons\n\u2502\n\u251c\u2500\u2500 fara_chat/              # \u041c\u043e\u0434\u0443\u043b\u044c \u0447\u0430\u0442\u0430\n\u251c\u2500\u2500 fara_leads/             # \u041c\u043e\u0434\u0443\u043b\u044c \u043b\u0438\u0434\u043e\u0432\n\u251c\u2500\u2500 fara_sales/             # \u041c\u043e\u0434\u0443\u043b\u044c \u043f\u0440\u043e\u0434\u0430\u0436\n\u251c\u2500\u2500 fara_partners/          # \u041c\u043e\u0434\u0443\u043b\u044c \u043f\u0430\u0440\u0442\u043d\u0451\u0440\u043e\u0432\n\u251c\u2500\u2500 fara_products/          # \u041c\u043e\u0434\u0443\u043b\u044c \u0442\u043e\u0432\u0430\u0440\u043e\u0432\n\u251c\u2500\u2500 fara_tasks/             # \u041c\u043e\u0434\u0443\u043b\u044c \u0437\u0430\u0434\u0430\u0447\n\u251c\u2500\u2500 fara_users/             # \u041c\u043e\u0434\u0443\u043b\u044c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\n\u251c\u2500\u2500 fara_security/          # \u041c\u043e\u0434\u0443\u043b\u044c \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438\n\u251c\u2500\u2500 fara_company/           # \u041c\u043e\u0434\u0443\u043b\u044c \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0439\n\u2514\u2500\u2500 fara_contract/          # \u041c\u043e\u0434\u0443\u043b\u044c \u0434\u043e\u0433\u043e\u0432\u043e\u0440\u043e\u0432\n</code></pre>"},{"location":"frontend/#_4","title":"\u0420\u0430\u0437\u0434\u0435\u043b\u044b","text":"<ul> <li>\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 \u2014 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b, \u043c\u043e\u0434\u0443\u043b\u0438, routing</li> <li>State Management \u2014 Redux store, RTK Query</li> <li>\u041c\u043e\u0434\u0443\u043b\u0438 \u2014 Chat UI</li> <li>API-\u0441\u0435\u0440\u0432\u0438\u0441\u044b \u2014 CRUD API \u043a\u043b\u0438\u0435\u043d\u0442</li> </ul>"},{"location":"frontend/architecture/overview/","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 Frontend","text":""},{"location":"frontend/architecture/overview/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<pre><code>graph TB\n    subgraph UI[\"React Components\"]\n        L[Layout]\n        P[Pages / Modules]\n        C[Shared Components]\n    end\n\n    subgraph State[\"State Management\"]\n        ST[Redux Store]\n        SL[Slices: auth, ...]\n        RTK[RTK Query Cache]\n    end\n\n    subgraph Services\n        CRUD[crudApi \u2014 universal CRUD]\n        CHAT[chat API]\n        AUTH[auth API]\n        WS[WebSocket]\n    end\n\n    P --&gt; ST\n    P --&gt; RTK\n    RTK --&gt; CRUD\n    RTK --&gt; CHAT\n    CRUD --&gt; BE[Backend API]\n    CHAT --&gt; BE\n    AUTH --&gt; BE\n    WS --&gt; BE\n\n    style BE fill:#336791,color:white</code></pre>"},{"location":"frontend/architecture/overview/#_2","title":"\u041c\u043e\u0434\u0443\u043b\u044c\u043d\u0430\u044f \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430","text":"<p>\u041a\u0430\u0436\u0434\u044b\u0439 CRM-\u043c\u043e\u0434\u0443\u043b\u044c \u2014 \u0441\u0430\u043c\u043e\u0441\u0442\u043e\u044f\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u043f\u0430\u043f\u043a\u0430:</p> <pre><code>fara_chat/\n\u251c\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 ChatPage.tsx          # \u0413\u043b\u0430\u0432\u043d\u0430\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 \u0447\u0430\u0442\u0430\n\u2502   \u251c\u2500\u2500 ChatList.tsx          # \u0421\u043f\u0438\u0441\u043e\u043a \u0447\u0430\u0442\u043e\u0432\n\u2502   \u251c\u2500\u2500 MessageList.tsx       # \u0421\u043f\u0438\u0441\u043e\u043a \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439\n\u2502   \u2514\u2500\u2500 MessageInput.tsx      # \u0412\u0432\u043e\u0434 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n\u251c\u2500\u2500 hooks/\n\u2502   \u251c\u2500\u2500 useChat.ts            # \u0425\u0443\u043a \u0434\u043b\u044f \u0447\u0430\u0442-\u043b\u043e\u0433\u0438\u043a\u0438\n\u2502   \u2514\u2500\u2500 useWebSocket.ts       # WebSocket \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435\n\u251c\u2500\u2500 context/\n\u2502   \u2514\u2500\u2500 ChatContext.tsx        # React Context \u0434\u043b\u044f \u0447\u0430\u0442\u0430\n\u2514\u2500\u2500 locales/\n    \u251c\u2500\u2500 ru.json\n    \u2514\u2500\u2500 en.json\n</code></pre>"},{"location":"frontend/architecture/overview/#routing","title":"Routing","text":"frontend/src/route/Routers.tsx<pre><code>const routes = [\n    { path: \"/chats\",     component: ChatPage },\n    { path: \"/leads\",     component: LeadsPage },\n    { path: \"/sales\",     component: SalesPage },\n    { path: \"/partners\",  component: PartnersPage },\n    { path: \"/products\",  component: ProductsPage },\n    { path: \"/tasks\",     component: TasksPage },\n    { path: \"/users\",     component: UsersPage },\n    { path: \"/settings\",  component: SettingsPage },\n];\n</code></pre>"},{"location":"frontend/architecture/overview/#ultilingual-i18n","title":"\u041cultilingual (i18n)","text":"<p>\u041a\u0430\u0436\u0434\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c \u0438\u043c\u0435\u0435\u0442 \u0441\u0432\u043e\u0438 \u043f\u0435\u0440\u0435\u0432\u043e\u0434\u044b \u0432 <code>locales/</code>:</p> fara_chat/locales/ru.json<pre><code>{\n    \"chat\": {\n        \"title\": \"\u0427\u0430\u0442\u044b\",\n        \"newChat\": \"\u041d\u043e\u0432\u044b\u0439 \u0447\u0430\u0442\",\n        \"typeMessage\": \"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435...\",\n        \"pinned\": \"\u0417\u0430\u043a\u0440\u0435\u043f\u043b\u0451\u043d\u043d\u044b\u0435\"\n    }\n}\n</code></pre> <pre><code>import { useTranslation } from 'react-i18next';\n\nfunction ChatHeader() {\n    const { t } = useTranslation();\n    return &lt;h1&gt;{t('chat.title')}&lt;/h1&gt;;\n}\n</code></pre>"},{"location":"frontend/architecture/state/","title":"State Management","text":"<p>Redux Toolkit + RTK Query \u0434\u043b\u044f \u0441\u0435\u0440\u0432\u0435\u0440\u043d\u043e\u0433\u043e \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f \u0438 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f.</p>"},{"location":"frontend/architecture/state/#store","title":"Store","text":"frontend/src/store/store.ts<pre><code>import { configureStore } from '@reduxjs/toolkit';\nimport { combineReducers } from 'redux';\nimport { crudApi } from '@services/api/crudApi';\nimport { authApi } from '@services/auth/auth';\nimport authSlice from '@slices/authSlice';\n\nconst reducers = combineReducers({\n    [crudApi.reducerPath]: crudApi.reducer,\n    [authApi.reducerPath]: authApi.reducer,\n    auth: authSlice,\n});\n\nexport const store = configureStore({\n    reducer: reducers,\n    middleware: (getDefaultMiddleware) =&gt;\n        getDefaultMiddleware()\n            .concat(crudApi.middleware)\n            .concat(authApi.middleware),\n});\n\nexport type RootState = ReturnType&lt;typeof store.getState&gt;;\nexport type AppDispatch = typeof store.dispatch;\n</code></pre>"},{"location":"frontend/architecture/state/#rtk-query","title":"RTK Query","text":"<p>\u0413\u043b\u0430\u0432\u043d\u0430\u044f \u0438\u0434\u0435\u044f: \u0441\u0435\u0440\u0432\u0435\u0440\u043d\u043e\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u2014 \u0447\u0435\u0440\u0435\u0437 RTK Query (\u0430\u0432\u0442\u043e\u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435, \u0438\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f). \u041a\u043b\u0438\u0435\u043d\u0442\u0441\u043a\u043e\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u2014 \u0447\u0435\u0440\u0435\u0437 slices (auth, UI state).</p>"},{"location":"frontend/architecture/state/#crudapi-crud","title":"crudApi \u2014 \u0443\u043d\u0438\u0432\u0435\u0440\u0441\u0430\u043b\u044c\u043d\u044b\u0439 CRUD","text":"<p>\u041e\u0434\u0438\u043d API-\u043a\u043b\u0438\u0435\u043d\u0442 \u0434\u043b\u044f \u0432\u0441\u0435\u0445 \u043c\u043e\u0434\u0435\u043b\u0435\u0439:</p> frontend/src/services/api/crudApi.ts<pre><code>export const crudApi = createApi({\n    reducerPath: 'crudApi',\n    baseQuery: baseQueryWithReauth,\n    tagTypes: ['Fields', 'SavedFilters', 'Chat'],\n    endpoints: build =&gt; ({\n\n        search: build.query&lt;GetListResult, GetListParams&gt;({\n            query: (arg) =&gt; ({\n                method: 'POST',\n                url: `/${arg.model}/search`,\n                body: {\n                    filter: arg.filter,\n                    fields: arg.fields,\n                    limit: arg.limit,\n                    order: arg.order,\n                    sort: arg.sort,\n                },\n            }),\n        }),\n\n        read: build.query&lt;ReadResult, ReadParams&gt;({\n            query: (arg) =&gt; ({\n                url: `/${arg.model}/read/${arg.id}`,\n                params: { fields: arg.fields?.join(',') },\n            }),\n        }),\n\n        create: build.mutation&lt;CreateResult, CreateParams&gt;({\n            query: (arg) =&gt; ({\n                method: 'POST',\n                url: `/${arg.model}/create`,\n                body: arg.data,\n            }),\n        }),\n\n        edit: build.mutation&lt;EditResult, EditParams&gt;({\n            query: (arg) =&gt; ({\n                method: 'PATCH',\n                url: `/${arg.model}/update/${arg.id}`,\n                body: arg.data,\n            }),\n        }),\n\n        deleteList: build.mutation&lt;DeleteListResult, DeleteListParams&gt;({\n            query: (arg) =&gt; ({\n                method: 'DELETE',\n                url: `/${arg.model}/delete`,\n                body: { ids: arg.ids },\n            }),\n        }),\n    }),\n});\n</code></pre>"},{"location":"frontend/architecture/state/#_1","title":"\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 \u0432 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u0430\u0445","text":"<pre><code>import { crudApi } from '@services/api/crudApi';\n\nfunction ProductList() {\n    const { data, isLoading } = crudApi.useSearchQuery({\n        model: 'products',\n        filter: [['active', '=', true]],\n        fields: ['id', 'name', 'price'],\n        limit: 20,\n    });\n\n    if (isLoading) return &lt;Loader /&gt;;\n\n    return (\n        &lt;DataTable\n            records={data?.data ?? []}\n            columns={[\n                { accessor: 'name', title: '\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435' },\n                { accessor: 'price', title: '\u0426\u0435\u043d\u0430' },\n            ]}\n        /&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/architecture/state/#auth-slice","title":"Auth Slice","text":"frontend/src/slices/authSlice.ts<pre><code>const authSlice = createSlice({\n    name: 'auth',\n    initialState: { token: null, user: null },\n    reducers: {\n        setCredentials: (state, action) =&gt; {\n            state.token = action.payload.token;\n            state.user = action.payload.user;\n        },\n        logout: (state) =&gt; {\n            state.token = null;\n            state.user = null;\n        },\n    },\n});\n</code></pre>"},{"location":"frontend/modules/chat/","title":"Chat Module (Frontend)","text":"<p>Real-time \u0447\u0430\u0442 \u0441 WebSocket, \u043e\u043f\u0442\u0438\u043c\u0438\u0441\u0442\u0438\u0447\u043d\u044b\u043c\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f\u043c\u0438 \u0438 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u043e\u0439 \u043c\u0443\u043b\u044c\u0442\u0438\u043c\u0435\u0434\u0438\u0430.</p>"},{"location":"frontend/modules/chat/#_1","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430","text":"<pre><code>fara_chat/\n\u251c\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 ChatPage.tsx          # \u0413\u043b\u0430\u0432\u043d\u0430\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430: \u0441\u043f\u0438\u0441\u043e\u043a + \u0447\u0430\u0442\n\u2502   \u251c\u2500\u2500 ChatList.tsx          # Sidebar \u0441\u043e \u0441\u043f\u0438\u0441\u043a\u043e\u043c \u0447\u0430\u0442\u043e\u0432\n\u2502   \u251c\u2500\u2500 MessageList.tsx       # \u041b\u0435\u043d\u0442\u0430 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439\n\u2502   \u251c\u2500\u2500 MessageInput.tsx      # \u041f\u043e\u043b\u0435 \u0432\u0432\u043e\u0434\u0430 + \u0432\u043b\u043e\u0436\u0435\u043d\u0438\u044f\n\u2502   \u251c\u2500\u2500 MessageBubble.tsx     # \u041e\u0434\u043d\u043e \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435\n\u2502   \u251c\u2500\u2500 PinnedMessages.tsx    # \u0417\u0430\u043a\u0440\u0435\u043f\u043b\u0451\u043d\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\n\u2502   \u2514\u2500\u2500 ReactionPicker.tsx    # \u0412\u044b\u0431\u043e\u0440 \u0440\u0435\u0430\u043a\u0446\u0438\u0438\n\u251c\u2500\u2500 hooks/\n\u2502   \u251c\u2500\u2500 useChat.ts            # \u041b\u043e\u0433\u0438\u043a\u0430 \u0447\u0430\u0442\u0430\n\u2502   \u2514\u2500\u2500 useWebSocket.ts       # WS-\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435\n\u251c\u2500\u2500 context/\n\u2502   \u2514\u2500\u2500 ChatContext.tsx        # \u041a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u0447\u0430\u0442\u0430\n\u2514\u2500\u2500 locales/\n    \u251c\u2500\u2500 ru.json\n    \u2514\u2500\u2500 en.json\n</code></pre>"},{"location":"frontend/modules/chat/#websocket","title":"WebSocket","text":"fara_chat/hooks/useWebSocket.ts<pre><code>import { useEffect, useRef } from 'react';\n\nexport function useWebSocket(token: string, onMessage: (data: any) =&gt; void) {\n    const ws = useRef&lt;WebSocket | null&gt;(null);\n\n    useEffect(() =&gt; {\n        const url = `${WS_BASE_URL}/ws?token=${token}`;\n        ws.current = new WebSocket(url);\n\n        ws.current.onmessage = (event) =&gt; {\n            const data = JSON.parse(event.data);\n            onMessage(data);\n        };\n\n        ws.current.onclose = () =&gt; {\n            // Reconnect logic\n            setTimeout(() =&gt; {\n                ws.current = new WebSocket(url);\n            }, 3000);\n        };\n\n        return () =&gt; ws.current?.close();\n    }, [token]);\n\n    return ws;\n}\n</code></pre>"},{"location":"frontend/modules/chat/#ws-","title":"\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 WS-\u0441\u043e\u0431\u044b\u0442\u0438\u0439","text":"fara_chat/components/ChatPage.tsx<pre><code>function ChatPage() {\n    const { token } = useAuth();\n    const [messages, setMessages] = useState&lt;Message[]&gt;([]);\n\n    const handleWsMessage = useCallback((data: WsEvent) =&gt; {\n        switch (data.type) {\n            case 'new_message':\n                setMessages(prev =&gt; [...prev, data.message]);\n                break;\n\n            case 'message_edited':\n                setMessages(prev =&gt;\n                    prev.map(m =&gt;\n                        m.id === data.message_id\n                            ? { ...m, body: data.body, is_edited: true }\n                            : m\n                    )\n                );\n                break;\n\n            case 'message_deleted':\n                setMessages(prev =&gt;\n                    prev.filter(m =&gt; m.id !== data.message_id)\n                );\n                break;\n\n            case 'message_pinned':\n                setMessages(prev =&gt;\n                    prev.map(m =&gt;\n                        m.id === data.message_id\n                            ? { ...m, pinned: data.pinned }\n                            : m\n                    )\n                );\n                break;\n        }\n    }, []);\n\n    useWebSocket(token, handleWsMessage);\n\n    return (\n        &lt;ChatLayout&gt;\n            &lt;ChatList /&gt;\n            &lt;MessageList messages={messages} /&gt;\n            &lt;MessageInput chatId={currentChatId} /&gt;\n        &lt;/ChatLayout&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/modules/chat/#_2","title":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b","text":""},{"location":"frontend/modules/chat/#messageinput","title":"MessageInput","text":"fara_chat/components/MessageInput.tsx<pre><code>function MessageInput({ chatId }: { chatId: number }) {\n    const [body, setBody] = useState('');\n    const [sendMessage] = chatApi.useSendMessageMutation();\n\n    const handleSend = async () =&gt; {\n        if (!body.trim()) return;\n\n        await sendMessage({\n            chatId,\n            body: body.trim(),\n            attachments: [],\n        });\n\n        setBody('');\n    };\n\n    return (\n        &lt;Group&gt;\n            &lt;Textarea\n                value={body}\n                onChange={(e) =&gt; setBody(e.target.value)}\n                placeholder={t('chat.typeMessage')}\n                onKeyDown={(e) =&gt; {\n                    if (e.key === 'Enter' &amp;&amp; !e.shiftKey) {\n                        e.preventDefault();\n                        handleSend();\n                    }\n                }}\n            /&gt;\n            &lt;ActionIcon onClick={handleSend}&gt;\n                &lt;IconSend /&gt;\n            &lt;/ActionIcon&gt;\n        &lt;/Group&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/modules/chat/#messagebubble","title":"MessageBubble","text":"fara_chat/components/MessageBubble.tsx<pre><code>function MessageBubble({ message, isOwn }: Props) {\n    return (\n        &lt;Paper\n            p=\"sm\"\n            radius=\"md\"\n            bg={isOwn ? 'blue.0' : 'gray.0'}\n            ml={isOwn ? 'auto' : 0}\n            maw=\"70%\"\n        &gt;\n            {!isOwn &amp;&amp; (\n                &lt;Text size=\"xs\" fw={600} c=\"blue\"&gt;\n                    {message.author_name}\n                &lt;/Text&gt;\n            )}\n\n            &lt;Text size=\"sm\"&gt;{message.body}&lt;/Text&gt;\n\n            &lt;Group gap={4} mt={4}&gt;\n                &lt;Text size=\"xs\" c=\"dimmed\"&gt;\n                    {formatTime(message.created_at)}\n                &lt;/Text&gt;\n                {message.is_edited &amp;&amp; (\n                    &lt;Text size=\"xs\" c=\"dimmed\"&gt;(\u0440\u0435\u0434.)&lt;/Text&gt;\n                )}\n                {message.pinned &amp;&amp; &lt;IconPin size={12} /&gt;}\n            &lt;/Group&gt;\n        &lt;/Paper&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/services/crud-api/","title":"CRUD API Service","text":"<p>\u0423\u043d\u0438\u0432\u0435\u0440\u0441\u0430\u043b\u044c\u043d\u044b\u0439 RTK Query \u043a\u043b\u0438\u0435\u043d\u0442 \u0434\u043b\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u0441 \u043b\u044e\u0431\u043e\u0439 DotORM-\u043c\u043e\u0434\u0435\u043b\u044c\u044e.</p>"},{"location":"frontend/services/crud-api/#_1","title":"\u041a\u043e\u043d\u0446\u0435\u043f\u0446\u0438\u044f","text":"<p>Backend \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0433\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u0442 CRUD-\u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442\u044b \u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0439 \u043c\u043e\u0434\u0435\u043b\u0438. Frontend \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 \u043e\u0434\u0438\u043d <code>crudApi</code> \u0434\u043b\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u0441\u043e \u0432\u0441\u0435\u043c\u0438 \u043c\u043e\u0434\u0435\u043b\u044f\u043c\u0438 \u2014 \u0438\u043c\u044f \u043c\u043e\u0434\u0435\u043b\u0438 \u043f\u0435\u0440\u0435\u0434\u0430\u0451\u0442\u0441\u044f \u043a\u0430\u043a \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440.</p> <pre><code>graph LR\n    C[Component] --&gt;|useSearchQuery| RTK[RTK Query]\n    RTK --&gt;|POST /products/search| BE[Backend CRUD Auto]\n    BE --&gt;|DotORM| DB[(PostgreSQL)]\n\n    style RTK fill:#764abc,color:white\n    style BE fill:#009688,color:white</code></pre>"},{"location":"frontend/services/crud-api/#_2","title":"\u0422\u0438\u043f\u044b","text":"frontend/src/services/api/crudTypes.ts<pre><code>// \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u043f\u043e\u0438\u0441\u043a\u0430\ninterface GetListParams {\n    model: string;                         // \u0438\u043c\u044f \u043c\u043e\u0434\u0435\u043b\u0438 (\"products\", \"users\")\n    filter?: Array&lt;[string, string, any]&gt;; // [field, operator, value]\n    fields?: string[];\n    order?: string;\n    sort?: 'asc' | 'desc';\n    start?: number;\n    end?: number;\n    limit?: number;\n}\n\n// \u0420\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442 \u043f\u043e\u0438\u0441\u043a\u0430\ninterface GetListResult&lt;T = FaraRecord&gt; {\n    data: T[];\n    total: number;\n}\n\n// \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u0447\u0442\u0435\u043d\u0438\u044f\ninterface ReadParams {\n    model: string;\n    id: number;\n    fields?: string[];\n}\n\n// \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f\ninterface CreateParams {\n    model: string;\n    data: Record&lt;string, any&gt;;\n}\n\n// \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f\ninterface EditParams {\n    model: string;\n    id: number;\n    data: Record&lt;string, any&gt;;\n}\n\n// \u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u044f\ninterface DeleteListParams {\n    model: string;\n    ids: number[];\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#_3","title":"\u0425\u0443\u043a\u0438","text":"<p>RTK Query \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0433\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u0442 \u0445\u0443\u043a\u0438 \u0438\u0437 endpoints:</p>"},{"location":"frontend/services/crud-api/#usesearchquery","title":"useSearchQuery","text":"<pre><code>import { crudApi } from '@services/api/crudApi';\n\nfunction PartnerList() {\n    const { data, isLoading, error, refetch } = crudApi.useSearchQuery({\n        model: 'partners',\n        filter: [\n            ['active', '=', true],\n            ['name', 'ilike', '%john%'],\n        ],\n        fields: ['id', 'name', 'email', 'phone'],\n        order: 'name',\n        sort: 'asc',\n        limit: 50,\n    });\n\n    if (isLoading) return &lt;Loader /&gt;;\n    if (error) return &lt;Alert color=\"red\"&gt;\u041e\u0448\u0438\u0431\u043a\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438&lt;/Alert&gt;;\n\n    return (\n        &lt;DataTable\n            records={data?.data ?? []}\n            columns={[\n                { accessor: 'name' },\n                { accessor: 'email' },\n                { accessor: 'phone' },\n            ]}\n        /&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#usereadquery","title":"useReadQuery","text":"<pre><code>function ProductDetail({ id }: { id: number }) {\n    const { data } = crudApi.useReadQuery({\n        model: 'products',\n        id,\n        fields: ['id', 'name', 'price', 'description', 'category_id'],\n    });\n\n    return &lt;ProductForm initialValues={data?.data} /&gt;;\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#usecreatemutation","title":"useCreateMutation","text":"<pre><code>function CreatePartnerForm() {\n    const [create, { isLoading }] = crudApi.useCreateMutation();\n\n    const handleSubmit = async (values: PartnerForm) =&gt; {\n        const result = await create({\n            model: 'partners',\n            data: values,\n        }).unwrap();\n\n        notifications.show({\n            title: '\u0421\u043e\u0437\u0434\u0430\u043d\u043e',\n            message: `\u041f\u0430\u0440\u0442\u043d\u0451\u0440 #${result.data.id} \u0441\u043e\u0437\u0434\u0430\u043d`,\n        });\n    };\n\n    return &lt;Form onSubmit={handleSubmit} loading={isLoading} /&gt;;\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#useeditmutation","title":"useEditMutation","text":"<pre><code>function EditProductForm({ id }: { id: number }) {\n    const [edit, { isLoading }] = crudApi.useEditMutation();\n\n    const handleSubmit = async (values: Partial&lt;Product&gt;) =&gt; {\n        await edit({\n            model: 'products',\n            id,\n            data: values,\n        }).unwrap();\n    };\n\n    return &lt;Form onSubmit={handleSubmit} loading={isLoading} /&gt;;\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#usedeletelistmutation","title":"useDeleteListMutation","text":"<pre><code>function DeleteButton({ ids }: { ids: number[] }) {\n    const [deleteList] = crudApi.useDeleteListMutation();\n\n    return (\n        &lt;Button\n            color=\"red\"\n            onClick={() =&gt; deleteList({ model: 'products', ids })}\n        &gt;\n            \u0423\u0434\u0430\u043b\u0438\u0442\u044c ({ids.length})\n        &lt;/Button&gt;\n    );\n}\n</code></pre>"},{"location":"frontend/services/crud-api/#_4","title":"\u041a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0438 \u0438\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f","text":"<p>RTK Query \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043a\u044d\u0448\u0438\u0440\u0443\u0435\u0442 \u043e\u0442\u0432\u0435\u0442\u044b \u0438 \u0438\u043d\u0432\u0430\u043b\u0438\u0434\u0438\u0440\u0443\u0435\u0442 \u043f\u0440\u0438 \u043c\u0443\u0442\u0430\u0446\u0438\u044f\u0445:</p> <pre><code>// crudApi endpoints\nsearch: build.query({\n    // ...\n    providesTags: (result, error, arg) =&gt;\n        result\n            ? [{ type: arg.model, id: 'LIST' }]\n            : [],\n}),\n\ncreate: build.mutation({\n    // ...\n    invalidatesTags: (result, error, arg) =&gt; [\n        { type: arg.model, id: 'LIST' },  // (1)!\n    ],\n}),\n</code></pre> <ol> <li>\u041f\u043e\u0441\u043b\u0435 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0437\u0430\u043f\u0438\u0441\u0438 RTK Query \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0440\u043e\u0441\u0438\u0442 \u0432\u0441\u0435 <code>search</code>-\u0437\u0430\u043f\u0440\u043e\u0441\u044b \u0434\u043b\u044f \u044d\u0442\u043e\u0439 \u043c\u043e\u0434\u0435\u043b\u0438.</li> </ol>"},{"location":"guides/","title":"\u0413\u0430\u0439\u0434\u044b","text":"<p>\u041f\u043e\u0448\u0430\u0433\u043e\u0432\u044b\u0435 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438 \u0434\u043b\u044f \u0442\u0438\u043f\u0438\u0447\u043d\u044b\u0445 \u0437\u0430\u0434\u0430\u0447 \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u043a\u0438.</p> \u0413\u0430\u0439\u0434 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041d\u043e\u0432\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 CRM-\u043c\u043e\u0434\u0443\u043b\u044f \u0441 \u043d\u0443\u043b\u044f: \u043c\u043e\u0434\u0435\u043b\u044c \u2192 API \u2192 UI WebSocket \u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 real-time \u0441\u043e\u0431\u044b\u0442\u0438\u0439 \u0432 \u043c\u043e\u0434\u0443\u043b\u044c"},{"location":"guides/new-module/","title":"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043d\u043e\u0432\u043e\u0433\u043e \u043c\u043e\u0434\u0443\u043b\u044f","text":"<p>\u041f\u043e\u0448\u0430\u0433\u043e\u0432\u044b\u0439 \u0433\u0430\u0439\u0434: \u043e\u0442 \u043c\u043e\u0434\u0435\u043b\u0438 \u0434\u043e UI \u0437\u0430 6 \u0448\u0430\u0433\u043e\u0432.</p> <p>\u041f\u0440\u0438\u043c\u0435\u0440</p> <p>\u0421\u043e\u0437\u0434\u0430\u0434\u0438\u043c \u043c\u043e\u0434\u0443\u043b\u044c Tickets \u2014 \u0441\u0438\u0441\u0442\u0435\u043c\u0430 \u0442\u0438\u043a\u0435\u0442\u043e\u0432 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438.</p>"},{"location":"guides/new-module/#1","title":"\u0428\u0430\u0433 1: \u041c\u043e\u0434\u0435\u043b\u044c","text":"backend/base/crm/tickets/models/ticket.py<pre><code>from backend.base.system.dotorm.dotorm.model import DotModel\nfrom backend.base.system.dotorm.dotorm.fields import (\n    Char, Text, Boolean, Selection, Datetime, Many2one\n)\n\n\nclass Ticket(DotModel):\n    __table__ = \"tickets\"\n\n    title: str = Char(max_length=255, required=True)\n    descriptione: str = Text()\n    statuse: str = Selection(\n        selection=[\n            (\"open\", \"\u041e\u0442\u043a\u0440\u044b\u0442\"),\n            (\"in_progress\", \"\u0412 \u0440\u0430\u0431\u043e\u0442\u0435\"),\n            (\"resolved\", \"\u0420\u0435\u0448\u0451\u043d\"),\n            (\"closed\", \"\u0417\u0430\u043a\u0440\u044b\u0442\"),\n        ],\n        default=\"open\",\n    )\n    priority: str = Selection(\n        selection=[\n            (\"low\", \"\u041d\u0438\u0437\u043a\u0438\u0439\"),\n            (\"medium\", \"\u0421\u0440\u0435\u0434\u043d\u0438\u0439\"),\n            (\"high\", \"\u0412\u044b\u0441\u043e\u043a\u0438\u0439\"),\n            (\"critical\", \"\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0439\"),\n        ],\n        default=\"medium\",\n    )\n    assigned_to: \"User | None\" = Many2one[\"User\"](relation_table=\"users\")\n    created_by: \"User\" = Many2one[\"User\"](relation_table=\"users\", required=True)\n    is_archived: bool = Boolean(default=False)\n</code></pre> backend/base/crm/tickets/models/__init__.py<pre><code>from .ticket import Ticket\n</code></pre>"},{"location":"guides/new-module/#2-service","title":"\u0428\u0430\u0433 2: Service","text":"backend/base/crm/tickets/app.py<pre><code>from backend.base.system.core.service import Service\n\n\nclass TicketsService(Service):\n    info = {\n        \"name\": \"Tickets\",\n        \"depends\": [\"security\"],\n    }\n\n    async def startup(self, app):\n        await super().startup(app)\n\n    async def shutdown(self, app):\n        pass\n</code></pre>"},{"location":"guides/new-module/#3","title":"\u0428\u0430\u0433 3: \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f","text":"backend/project_setup.py<pre><code>class Models(ModelsCore):\n    # ...\u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0438...\n    ticket = Ticket  # (1)!\n\n\nclass Apps(AppsCore):\n    # ...\u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435/ \u0441\u0435\u0440\u0432\u0438\u0441...\n    # \u0441\u0435\u0440\u0432\u0438\u0441 \u0447\u0442\u043e\u0431\u044b \u043e\u043d \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u043b\u0438\u0441\u044c \u0441\u0442\u0430\u0440\u0442\u0430\u043f \u0438 \u0448\u0430\u0442\u0434\u0430\u0443\u043d\n    # \u0430\u043f\u044b \u0434\u043b\u044f \u0442\u043e\u0433\u043e \u0447\u0442\u043e\u0431\u044b \u043f\u043e\u043d\u0438\u043c\u0430\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0438 \u0432\u0435\u0440\u0441\u0438\u0438 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0439\n    # \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u043d\u044b\u0445 \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0435\n    tickets = TicketsService() # (2)!\n</code></pre> <ol> <li>\u0418\u043c\u044f <code>ticket</code> \u2192 \u0434\u043e\u0441\u0442\u0443\u043f \u0447\u0435\u0440\u0435\u0437 <code>env.models.ticket</code></li> <li>\u041f\u0443\u0442\u044c \u043a \u043c\u043e\u0434\u0443\u043b\u044e \u2192 Environment \u043d\u0430\u0439\u0434\u0451\u0442 <code>app.py</code> \u0438 <code>routers/</code></li> </ol> <p>\u0413\u043e\u0442\u043e\u0432\u043e \u2014 CRUD API \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442</p> <p>\u041f\u043e\u0441\u043b\u0435 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u043a\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430 \u043c\u043e\u0434\u0435\u043b\u044c \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442\u044b:</p> <ul> <li><code>POST /tickets/search</code></li> <li><code>POST /tickets/create</code></li> <li><code>GET /tickets/read/{id}</code></li> <li><code>PATCH /tickets/update/{id}</code></li> <li><code>DELETE /tickets/delete</code></li> </ul>"},{"location":"guides/new-module/#4","title":"\u0428\u0430\u0433 4: \u041a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u044b (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)","text":"<p>\u0415\u0441\u043b\u0438 \u043d\u0443\u0436\u043d\u0430 \u0431\u0438\u0437\u043d\u0435\u0441-\u043b\u043e\u0433\u0438\u043a\u0430 \u043f\u043e\u043c\u0438\u043c\u043e CRUD:</p> backend/base/crm/tickets/routers/tickets.py<pre><code>from fastapi import APIRouter, Request\nfrom typing import TYPE_CHECKING\nif TYPE_CHECKING:\n    from backend.base.system.core.enviroment import Environment\n    from backend.base.crm.security.models.sessions import Session\nrouter_private = APIRouter(prefix=\"/tickets\", tags=[\"Tickets\"])\n\n\n@router_private.post(\"/{ticket_id}/assign\")\nasync def assign_ticket(req: Request, ticket_id: int, body: AssignBody):\n    \"\"\"\u041d\u0430\u0437\u043d\u0430\u0447\u0438\u0442\u044c \u0442\u0438\u043a\u0435\u0442 \u043d\u0430 \u0441\u043e\u0442\u0440\u0443\u0434\u043d\u0438\u043a\u0430.\"\"\"\n    env: \"Environment\" = req.app.state.env\n    auth_session: \"Session\" = req.state.session\n    user_id = auth_session.user_id.id\n\n    ticket = await env.models.ticket.get(ticket_id)\n    await ticket.update(env.models.ticket(\n        assigned_to=body.user_id,\n        status=\"in_progress\",\n    ))\n\n    return {\"success\": True}\n\n\n@router_private.post(\"/{ticket_id}/close\")\nasync def close_ticket(req: Request, ticket_id: int):\n    \"\"\"\u0417\u0430\u043a\u0440\u044b\u0442\u044c \u0442\u0438\u043a\u0435\u0442.\"\"\"\n    env: \"Environment\" = req.app.state.env\n\n    ticket = await env.models.ticket.get(ticket_id)\n    await ticket.update(env.models.ticket(status=\"closed\"))\n\n    return {\"success\": True}\n</code></pre>"},{"location":"guides/new-module/#5-frontend-api-service","title":"\u0428\u0430\u0433 5: Frontend \u2014 API service","text":"frontend/src/services/api/tickets.ts<pre><code>// \u0414\u043b\u044f \u0431\u0430\u0437\u043e\u0432\u043e\u0433\u043e CRUD \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 crudApi:\nimport { crudApi } from './crudApi';\n\n// \u0414\u043b\u044f \u043a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0445 \u044d\u043d\u0434\u043f\u043e\u0438\u043d\u0442\u043e\u0432 \u2014 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u044b\u0439 API:\nexport const ticketApi = crudApi.injectEndpoints({\n    endpoints: (build) =&gt; ({\n        assignTicket: build.mutation&lt;void, { ticketId: number; userId: number }&gt;({\n            query: ({ ticketId, userId }) =&gt; ({\n                method: 'POST',\n                url: `/tickets/${ticketId}/assign`,\n                body: { user_id: userId },\n            }),\n            invalidatesTags: ['tickets'],\n        }),\n\n        closeTicket: build.mutation&lt;void, { ticketId: number }&gt;({\n            query: ({ ticketId }) =&gt; ({\n                method: 'POST',\n                url: `/tickets/${ticketId}/close`,\n            }),\n            invalidatesTags: ['tickets'],\n        }),\n    }),\n});\n\nexport const { useAssignTicketMutation, useCloseTicketMutation } = ticketApi;\n</code></pre>"},{"location":"guides/new-module/#6-frontend","title":"\u0428\u0430\u0433 6: Frontend \u2014 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442","text":"frontend/src/fara_tickets/components/TicketList.tsx<pre><code>import { crudApi } from '@services/api/crudApi';\nimport { DataTable } from 'mantine-datatable';\n\nfunction TicketList() {\n    const { data, isLoading } = crudApi.useSearchQuery({\n        model: 'tickets',\n        filter: [['is_archived', '=', false]],\n        fields: ['id', 'title', 'status', 'priority', 'assigned_to'],\n        order: 'id',\n        sort: 'desc',\n        limit: 50,\n    });\n\n    const statusColors: Record&lt;string, string&gt; = {\n        open: 'blue',\n        in_progress: 'yellow',\n        resolved: 'green',\n        closed: 'gray',\n    };\n\n    return (\n        &lt;DataTable\n            records={data?.data ?? []}\n            fetching={isLoading}\n            columns={[\n                { accessor: 'id', width: 80 },\n                { accessor: 'title', title: '\u0422\u0435\u043c\u0430' },\n                {\n                    accessor: 'status',\n                    title: '\u0421\u0442\u0430\u0442\u0443\u0441',\n                    render: (r) =&gt; (\n                        &lt;Badge color={statusColors[r.status]}&gt;\n                            {r.status}\n                        &lt;/Badge&gt;\n                    ),\n                },\n                { accessor: 'priority', title: '\u041f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442' },\n            ]}\n        /&gt;\n    );\n}\n</code></pre>"},{"location":"guides/new-module/#_2","title":"\u0427\u0435\u043a\u043b\u0438\u0441\u0442","text":"<ul> <li> \u041c\u043e\u0434\u0435\u043b\u044c \u0432 <code>models/</code></li> <li> Service \u0432 <code>app.py</code></li> <li> \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u0432 <code>project_setup.py</code> (Models + Apps.installed)</li> <li> \u041a\u0430\u0441\u0442\u043e\u043c\u043d\u044b\u0435 \u0440\u043e\u0443\u0442\u0435\u0440\u044b (\u0435\u0441\u043b\u0438 \u043d\u0443\u0436\u043d\u044b)</li> <li> Frontend API service</li> <li> Frontend \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b</li> <li> \u041b\u043e\u043a\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f (<code>locales/ru.json</code>, <code>locales/en.json</code>)</li> <li> \u0422\u0435\u0441\u0442\u044b</li> </ul>"},{"location":"guides/websocket/","title":"WebSocket \u2014 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 real-time \u0441\u043e\u0431\u044b\u0442\u0438\u0439","text":"<p>\u041a\u0430\u043a \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c WebSocket-\u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u044f \u0432 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0439 \u043c\u043e\u0434\u0443\u043b\u044c.</p>"},{"location":"guides/websocket/#_1","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430","text":"<pre><code>sequenceDiagram\n    participant C1 as Client 1\n    participant API as FastAPI Router\n    participant CM as ConnectionManager\n    participant PS as PubSub (PG/Redis)\n    participant C2 as Client 2\n\n    C1-&gt;&gt;API: POST /tickets/1/assign\n    API-&gt;&gt;API: business logic\n    API-&gt;&gt;CM: send_to_user(user_id, event)\n    CM-&gt;&gt;PS: publish(\"send_to_user\", {...})\n    PS-&gt;&gt;CM: notification (all workers)\n    CM-&gt;&gt;C2: WebSocket: {\"type\": \"ticket_assigned\"}</code></pre>"},{"location":"guides/websocket/#backend","title":"Backend \u2014 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0441\u043e\u0431\u044b\u0442\u0438\u044f","text":""},{"location":"guides/websocket/#1-chat_manager","title":"1. \u0418\u043c\u043f\u043e\u0440\u0442 chat_manager","text":"backend/base/crm/tickets/routers/tickets.py<pre><code>from backend.base.crm.chat.websocket import chat_manager\n</code></pre>"},{"location":"guides/websocket/#2","title":"2. \u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u043f\u043e\u0441\u043b\u0435 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u044f","text":"<pre><code>@router_private.post(\"/{ticket_id}/assign\")\nasync def assign_ticket(req: Request, ticket_id: int, body: AssignBody):\n    env: \"Environment\" = req.app.state.env\n\n    ticket = await env.models.ticket.get(ticket_id)\n    await ticket.update(env.models.ticket(\n        assigned_to=body.user_id,\n        status=\"in_progress\",\n    ))\n\n    # \u0423\u0432\u0435\u0434\u043e\u043c\u0438\u0442\u044c \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u043d\u043e\u0433\u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n    await chat_manager.send_to_user(             # (1)!\n        user_id=body.user_id,\n        message={\n            \"type\": \"ticket_assigned\",\n            \"ticket_id\": ticket_id,\n            \"title\": ticket.title,\n        },\n    )\n\n    return {\"success\": True}\n</code></pre> <ol> <li><code>send_to_user</code> \u2014 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u043e\u0431\u044b\u0442\u0438\u0435 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u043e\u043c\u0443 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044e \u0447\u0435\u0440\u0435\u0437 \u0432\u0441\u0435 \u0435\u0433\u043e WebSocket-\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f (\u0432\u043a\u043b\u044e\u0447\u0430\u044f \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043a\u043b\u0430\u0434\u043a\u0438 \u0438 worker-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b).</li> </ol>"},{"location":"guides/websocket/#_2","title":"\u041c\u0435\u0442\u043e\u0434\u044b \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438","text":"\u041c\u0435\u0442\u043e\u0434 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>send_to_chat(chat_id, message)</code> \u0412\u0441\u0435\u043c \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430\u043c \u0447\u0430\u0442\u0430 <code>send_to_user(user_id, message)</code> \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u043e\u043c\u0443 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044e"},{"location":"guides/websocket/#frontend","title":"Frontend \u2014 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0441\u043e\u0431\u044b\u0442\u0438\u044f","text":"frontend/src/fara_tickets/hooks/useTicketEvents.ts<pre><code>import { useWebSocket } from '@fara_chat/hooks/useWebSocket';\nimport { notifications } from '@mantine/notifications';\n\nexport function useTicketEvents() {\n    const handleMessage = useCallback((data: any) =&gt; {\n        switch (data.type) {\n            case 'ticket_assigned':\n                // \u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435\n                notifications.show({\n                    title: '\u041d\u043e\u0432\u044b\u0439 \u0442\u0438\u043a\u0435\u0442',\n                    message: `\u0412\u0430\u043c \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d \u0442\u0438\u043a\u0435\u0442: ${data.title}`,\n                    color: 'blue',\n                });\n\n                // \u0418\u043d\u0432\u0430\u043b\u0438\u0434\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043a\u044d\u0448 \u0441\u043f\u0438\u0441\u043a\u0430 \u0442\u0438\u043a\u0435\u0442\u043e\u0432\n                dispatch(\n                    crudApi.util.invalidateTags([\n                        { type: 'tickets', id: 'LIST' }\n                    ])\n                );\n                break;\n\n            case 'ticket_status_changed':\n                // \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0442\u0438\u043a\u0435\u0442 \u0432 \u043a\u044d\u0448\u0435\n                dispatch(\n                    crudApi.util.updateQueryData(\n                        'read',\n                        { model: 'tickets', id: data.ticket_id },\n                        (draft) =&gt; {\n                            draft.data.status = data.status;\n                        }\n                    )\n                );\n                break;\n        }\n    }, [dispatch]);\n\n    useWebSocket(token, handleMessage);\n}\n</code></pre>"},{"location":"guides/websocket/#_3","title":"\u0422\u0435\u0441\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435","text":"<p>\u0412 \u0442\u0435\u0441\u0442\u0430\u0445 \u043c\u043e\u043a\u0430\u0439 <code>send_to_chat</code> / <code>send_to_user</code>:</p> <pre><code>from unittest.mock import AsyncMock, patch\n\n@patch(\n    \"backend.base.crm.chat.websocket.chat_manager.send_to_user\",\n    new_callable=AsyncMock,\n)\nasync def test_assign_ticket_sends_notification(\n    self, mock_ws, authenticated_client\n):\n    client, user_id, token = authenticated_client\n    ticket_id = await self._create_ticket()\n\n    response = await client.post(\n        f\"/tickets/{ticket_id}/assign\",\n        json={\"user_id\": user_id},\n    )\n\n    assert response.status_code == 200\n\n    # \u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c \u0447\u0442\u043e WS-\u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043e\n    mock_ws.assert_called_once_with(\n        user_id=user_id,\n        message={\n            \"type\": \"ticket_assigned\",\n            \"ticket_id\": ticket_id,\n            \"title\": \"Test Ticket\",\n        },\n    )\n</code></pre> <p>\u041d\u0435 \u0437\u0430\u0431\u0443\u0434\u044c \u0437\u0430\u043c\u043e\u043a\u0430\u0442\u044c WebSocket</p> <p>\u0411\u0435\u0437 \u043c\u043e\u043a\u0430 <code>send_to_user</code> / <code>send_to_chat</code> \u0442\u0435\u0441\u0442 \u0443\u0439\u0434\u0451\u0442 \u0432 \u0440\u0435\u0430\u043b\u044c\u043d\u044b\u0439 PubSub \u0438 \u043c\u043e\u0436\u0435\u0442 \u0437\u0430\u0432\u0438\u0441\u043d\u0443\u0442\u044c (\u0435\u0441\u043b\u0438 PubSub listener \u0437\u0430\u043d\u044f\u043b \u0432\u0441\u0435 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f \u043f\u0443\u043b\u0430).</p>"}]}